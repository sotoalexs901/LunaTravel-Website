<!DOCTYPE html>
<html lang="es">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>Panel de Registro - Luna Travel</title>

Â  <!-- Fuente -->
Â  <link rel="preconnect" href="https://fonts.googleapis.com">
Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

Â  <!-- Estilos base -->
Â  <style>
Â  Â  :root{
Â  Â  Â  --primary:#213D7A; --primary-dark:#1a3163; --accent:#143c8c;
Â  Â  Â  --bg:#f7f9fc; --muted:#6b7280; --green:#1b5e20; --green-bg:#e6f9e6; --danger:#e74c3c;
Â  Â  Â  --card:#fff; --border:#e5e7eb; --shadow:0 4px 10px rgba(0,0,0,0.1);
Â  Â  }
Â  Â  *{box-sizing:border-box}
Â  Â  html,body{height:100%}
Â  Â  body{font-family:'Inter',sans-serif;background:var(--bg);margin:0;color:#111}
Â  Â  .container{max-width:980px;margin:32px auto;background:var(--card);padding:28px;border-radius:12px;box-shadow:var(--shadow)}
Â  Â  h2{margin:0 0 16px;color:var(--primary)}
Â  Â  input,select,button{font-family:inherit}
Â  Â  input,select{padding:10px;border:1px solid var(--border);border-radius:8px;width:100%}
Â  Â  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
Â  Â  .btn{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
Â  Â  .btn:hover{background:var(--primary-dark)}
Â  Â  .btn-danger{background:var(--danger)}
Â  Â  .btn-muted{background:#6b7280}
Â  Â  .toolbar{display:flex;gap:12px;flex-wrap:wrap;justify-content:space-between;align-items:center;margin:16px 0}

Â  Â  /* Tabla */
Â  Â  #tablaEnvios{width:100%;border-collapse:collapse;margin-top:12px}
Â  Â  #tablaEnvios th,#tablaEnvios td{border:1px solid var(--border);padding:8px;text-align:left}
Â  Â  #tablaEnvios th{background:var(--primary);color:#fff}
Â  Â  #contador{margin:8px 0 0;font-weight:700;color:var(--primary)}

Â  Â  /* Login */
Â  Â  #login{text-align:center}

Â  Â  /* Badge admin */
Â  Â  .admin-badge{display:none;margin-left:8px;padding:3px 8px;border-radius:999px;background:#10b981;color:#fff;font-size:12px;font-weight:700}

Â  Â  /* Toast Ok */
Â  Â  #mensajeConfirmacion{display:none;margin:15px auto;width:100%;padding:12px;background:var(--green-bg);color:var(--green);font-weight:600;border:1px solid #66bb6a;border-radius:8px;animation:fadeInOut 4s forwards;text-align:center}
Â  Â  @keyframes fadeInOut{0%{opacity:0}10%{opacity:1}90%{opacity:1}100%{opacity:0}}

Â  Â  /* Modal ediciÃ³n */
Â  Â  .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(4px);z-index:9990}
Â  Â  .modal{position:fixed;right:50%;top:50%;transform:translate(50%,-50%);background:#fff;border-radius:12px;box-shadow:var(--shadow);width:min(640px,95vw);padding:16px;z-index:9991}
Â  Â  .modal h3{margin:0 0 10px;color:var(--primary)}
Â  Â  .modal .grid{grid-template-columns:1fr 1fr}
Â  Â  .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

Â  Â  /* Chat lateral */
Â  Â  .chat-fab{display:none;position:fixed;right:20px;bottom:20px;background:var(--primary);color:#fff;border:none;border-radius:50%;width:56px;height:56px;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);cursor:pointer;z-index:9800;font-size:20px}
Â  Â  .chat-fab .badge{position:absolute;top:6px;right:6px;background:#3b82f6;border-radius:50%;width:10px;height:10px;display:none}
Â  Â  .chat-dock{display:none;position:fixed;top:0;right:-380px;width:360px;height:100vh;background:#fff;box-shadow:-4px 0 16px rgba(0,0,0,.15);z-index:9900;flex-direction:column;transition:right .25s ease}
Â  Â  .chat-dock.open{right:0}
Â  Â  .chat-header{background:var(--primary);color:#fff;padding:12px 14px;display:flex;justify-content:space-between;align-items:center}
Â  Â  .chat-messages{flex:1;overflow:auto;padding:12px;background:#f8fafc}
Â  Â  .msg{max-width:80%;margin:6px 0;padding:8px 10px;border-radius:10px}
Â  Â  .msg.mine{margin-left:auto;background:rgba(20,60,140,.1);border:1px solid #c7d2fe}
Â  Â  .msg.theirs{margin-right:auto;background:#e5e7eb}
Â  Â  .msg .meta{font-size:11px;color:#555;margin-top:2px}
Â  Â  .chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid var(--border)}
Â  Â  .chat-input input{flex:1}

Â  Â  @media (max-width:720px){.grid{grid-template-columns:1fr}.toolbar{flex-direction:column;align-items:stretch}}
Â  </style>

Â  <!-- LibrerÃ­as de exportaciÃ³n y PDF -->
Â  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
</head>

<body>
Â  <!-- LOGIN -->
Â  <div id="login" class="container">
Â  Â  <h2>Acceso Administrador</h2>
Â  Â  <div class="grid" style="max-width:520px;margin:0 auto;">
Â  Â  Â  <input type="text" id="usuario" placeholder="Usuario (Alexs / Mela / Amisaday / Juan / Ana)">
Â  Â  Â  <input type="password" id="pin" placeholder="PIN">
Â  Â  </div>
Â  Â  <button class="btn" onclick="login()">Ingresar</button>
Â  Â  <p id="loginError" style="color:#d32f2f;display:none;margin-top:8px;">Usuario o PIN incorrectos.</p>
Â  </div>

Â  <!-- PANEL -->
Â  <div id="panel" class="container" style="display:none;">
Â  Â  <div style="display:flex;align-items:center;justify-content:space-between;">
Â  Â  Â  <h2 style="display:flex;align-items:center;gap:8px;">Panel de Registro - Luna Travel <span id="adminBadge" class="admin-badge">ğŸ”‘ Modo Administrador Activo</span></h2>
Â  Â  Â  <button class="btn btn-muted" onclick="cerrarSesion()">Cerrar SesiÃ³n</button>
Â  Â  </div>

Â  Â  <!-- Registro -->
Â  Â  <div class="grid" style="margin-top:12px;">
Â  Â  Â  <input type="text" id="cliente" placeholder="Cliente">
Â  Â  Â  <input type="text" id="destinatario" placeholder="Destinatario (quien recoge)">
Â  Â  Â  <input type="text" id="destino" placeholder="Destino">
Â  Â  Â  <select id="estado">
Â  Â  Â  Â  <option value="">Seleccionar estado...</option>
Â  Â  Â  Â  <option>Recibido en la Oficina</option>
Â  Â  Â  Â  <option>En TrÃ¡nsito</option>
Â  Â  Â  Â  <option>Procesando para Entrega</option>
Â  Â  Â  Â  <option>En Reparto</option>
Â  Â  Â  Â  <option>Entregado</option>
Â  Â  Â  </select>
Â  Â  Â  <input type="text" id="ubicacion" placeholder="UbicaciÃ³n">
Â  Â  </div>
Â  Â  <button class="btn" onclick="guardarEnvio()">Guardar y generar recibo</button>

Â  Â  <div id="recibo"></div>

Â  Â  <!-- Filtros / Export -->
Â  Â  <div class="toolbar">
Â  Â  Â  <div>
Â  Â  Â  Â  <label for="filterEstado" style="font-weight:700;color:var(--primary);">Filtrar por estado:</label>
Â  Â  Â  Â  <select id="filterEstado" onchange="filtrarEnvios()" style="padding:8px;border-radius:8px;">
Â  Â  Â  Â  Â  <option value="todos">Todos</option>
Â  Â  Â  Â  Â  <option value="recibido en la oficina">Recibido en la Oficina</option>
Â  Â  Â  Â  Â  <option value="en trÃ¡nsito">En TrÃ¡nsito</option>
Â  Â  Â  Â  Â  <option value="procesando para entrega">Procesando para Entrega</option>
Â  Â  Â  Â  Â  <option value="en reparto">En Reparto</option>
Â  Â  Â  Â  Â  <option value="entregado">Entregado</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>
Â  Â  Â  <div style="display:flex;gap:8px;">
Â  Â  Â  Â  <button class="btn" onclick="exportarExcel()">ğŸ“¤ Exportar Excel</button>
Â  Â  Â  Â  <button class="btn" style="background:#c62828" onclick="exportarPDF()">ğŸ§¾ Exportar PDF</button>
Â  Â  Â  Â  <button class="btn btn-muted" onclick="imprimirFiltrado()">ğŸ–¨ï¸ Imprimir lista filtrada</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- EscÃ¡ner -->
Â  Â  <h3 style="margin:8px 0 6px;color:var(--primary)">Actualizar estado con escÃ¡ner</h3>
Â  Â  <input type="text" id="scanInput" placeholder="Escanee un cÃ³digo LT..." autofocus>
Â  Â  <div id="actualizarForm" style="display:none;margin-top:10px;">
Â  Â  Â  <div class="grid">
Â  Â  Â  Â  <select id="nuevoEstado">
Â  Â  Â  Â  Â  <option value="">Seleccionar nuevo estado...</option>
Â  Â  Â  Â  Â  <option>Recibido en la Oficina</option>
Â  Â  Â  Â  Â  <option>En TrÃ¡nsito</option>
Â  Â  Â  Â  Â  <option>Procesando para Entrega</option>
Â  Â  Â  Â  Â  <option>En Reparto</option>
Â  Â  Â  Â  Â  <option>Entregado</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <input type="text" id="nuevaUbicacion" placeholder="Nueva ubicaciÃ³n (opcional)">
Â  Â  Â  </div>
Â  Â  Â  <button class="btn" onclick="confirmarActualizacion()">Actualizar</button>
Â  Â  </div>

Â  Â  <div id="mensajeConfirmacion">âœ… EnvÃ­o actualizado correctamente.</div>

Â  Â  <!-- Tabla -->
Â  Â  <h3 style="margin:18px 0 6px;">EnvÃ­os registrados</h3>
Â  Â  <p id="contador">ğŸ“¦ 0 envÃ­os cargados</p>
Â  Â  <table id="tablaEnvios">
Â  Â  Â  <thead>
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <th>CÃ³digo</th>
Â  Â  Â  Â  Â  <th>Cliente</th>
Â  Â  Â  Â  Â  <th>Destinatario</th>
Â  Â  Â  Â  Â  <th>Destino</th>
Â  Â  Â  Â  Â  <th>Estado</th>
Â  Â  Â  Â  Â  <th>UbicaciÃ³n</th>
Â  Â  Â  Â  Â  <th>Fecha</th>
Â  Â  Â  Â  Â  <th>Actualizado por</th>
Â  Â  Â  Â  Â  <th>Acciones</th>
Â  Â  Â  Â  </tr>
Â  Â  Â  </thead>
Â  Â  Â  <tbody id="tablaBody"></tbody>
Â  Â  </table>
Â  </div>

Â  <!-- Modal ediciÃ³n (solo Alexs) -->
Â  <div id="modalBackdrop" class="modal-backdrop">
Â  Â  <div class="modal">
Â  Â  Â  <h3>Editar envÃ­o</h3>
Â  Â  Â  <div class="grid">
Â  Â  Â  Â  <input type="text" id="editCodigo" placeholder="CÃ³digo (LT-XXXXXX)">
Â  Â  Â  Â  <input type="text" id="editCliente" placeholder="Cliente">
Â  Â  Â  Â  <input type="text" id="editDestinatario" placeholder="Destinatario">
Â  Â  Â  Â  <input type="text" id="editDestino" placeholder="Destino">
Â  Â  Â  Â  <select id="editEstado">
Â  Â  Â  Â  Â  <option>Recibido en la Oficina</option>
Â  Â  Â  Â  Â  <option>En TrÃ¡nsito</option>
Â  Â  Â  Â  Â  <option>Procesando para Entrega</option>
Â  Â  Â  Â  Â  <option>En Reparto</option>
Â  Â  Â  Â  Â  <option>Entregado</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <input type="text" id="editUbicacion" placeholder="UbicaciÃ³n">
Â  Â  Â  Â  <input type="text" id="editFecha" placeholder="Fecha (auto si dejas vacÃ­o)">
Â  Â  Â  </div>
Â  Â  Â  <div class="modal-actions">
Â  Â  Â  Â  <button class="btn btn-muted" onclick="cerrarModal()">Cancelar</button>
Â  Â  Â  Â  <button class="btn" onclick="guardarEdicion()">Guardar cambios</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <!-- FAB y Dock del Chat (se muestran despuÃ©s del login) -->
Â  <button class="chat-fab" id="chatFab">ğŸ’¬<span class="badge" id="chatBadge"></span></button>
Â  <div class="chat-dock" id="chatDock">
Â  Â  <div class="chat-header">
Â  Â  Â  <strong>ğŸ’¬ Chat del Equipo</strong>
Â  Â  Â  <button class="btn btn-muted" onclick="toggleChat()">âŒ</button>
Â  Â  </div>
Â  Â  <div class="chat-messages" id="chatMessages"></div>
Â  Â  <div class="chat-input">
Â  Â  Â  <input type="text" id="chatText" placeholder="Escribe un mensaje...">
Â  Â  Â  <button class="btn" onclick="enviarMensaje()">Enviar</button>
Â  Â  </div>
Â  </div>

Â  <!-- Firebase + LÃ³gica -->
Â  <script type="module">
Â  Â  /* ===========================
Â  Â  Â  Â 1) Firebase (Ãºnica instancia)
Â  Â  Â  Â =========================== */
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
Â  Â  import {
Â  Â  Â  getFirestore, doc, setDoc, updateDoc, deleteDoc, getDoc,
Â  Â  Â  collection, addDoc, getDocs, onSnapshot, query, orderBy, where
Â  Â  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyBUiJ9u2GyPBovgoaS64r89E1tydCP5Na4",
Â  Â  Â  authDomain: "lunatrack-95199.firebaseapp.com",
Â  Â  Â  projectId: "lunatrack-95199",
Â  Â  Â  storageBucket: "lunatrack-95199.firebasestorage.app",
Â  Â  Â  messagingSenderId: "82970120947",
Â  Â  Â  appId: "1:82970120947:web:2d7b70d052816802c05d86",
Â  Â  Â  measurementId: "G-QCYKV5DXKD"
Â  Â  };
Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  const db Â = getFirestore(app);

Â  Â  /* ===========================
Â  Â  Â  Â 2) Estado global
Â  Â  Â  Â =========================== */
Â  Â  let registrosEnvios = [];
Â  Â  let registrosFiltrados = [];
Â  Â  let codigoActual = "";
Â  Â  let currentUser = "";
Â  Â  let isAdmin = false;
Â  Â  let editingDocId = "";

Â  Â  /* ===========================
Â  Â  Â  Â 3) Login & permisos
Â  Â  Â  Â =========================== */
Â  Â  window.login = function(){
Â  Â  Â  const u = document.getElementById("usuario").value.trim();
Â  Â  Â  const p = document.getElementById("pin").value.trim();

Â  Â  Â  const valid = {
Â  Â  Â  Â  "Alexs": "2036",
Â  Â  Â  Â  "Mela": "2006",
Â  Â  Â  Â  "Amisaday": "1994",
Â  Â  Â  Â  "Juan": "5304",
Â  Â  Â  Â  "Ana": "0503"
Â  Â  Â  };

Â  Â  Â  if(valid[u] && valid[u] === p){
Â  Â  Â  Â  // Persistimos usuario para chat/reload
Â  Â  Â  Â  localStorage.setItem("usuarioActual", u);
Â  Â  Â  Â  localStorage.setItem("rolUsuario", u === "Alexs" ? "admin" : "operador");

Â  Â  Â  Â  currentUser = u;
Â  Â  Â  Â  isAdmin Â  Â  = (u === "Alexs");

Â  Â  Â  Â  document.getElementById("login").style.display = "none";
Â  Â  Â  Â  document.getElementById("panel").style.display = "block";

Â  Â  Â  Â  const badge = document.getElementById("adminBadge");
Â  Â  Â  Â  if (badge) badge.style.display = isAdmin ? "inline-flex" : "none";

Â  Â  Â  Â  // Mostrar chat
Â  Â  Â  Â  document.getElementById("chatFab").style.display Â = "flex";
Â  Â  Â  Â  document.getElementById("chatDock").style.display = "flex";

Â  Â  Â  Â  initChat();
Â  Â  Â  Â  cargarEnvios();
Â  Â  Â  } else {
Â  Â  Â  Â  document.getElementById("loginError").style.display = "block";
Â  Â  Â  }
Â  Â  };

Â  Â  window.cerrarSesion = function(){
Â  Â  Â  localStorage.removeItem("usuarioActual");
Â  Â  Â  localStorage.removeItem("rolUsuario");
Â  Â  Â  currentUser = "";
Â  Â  Â  isAdmin = false;

Â  Â  Â  // Ocultar panel y chat
Â  Â  Â  document.getElementById("panel").style.display = "none";
Â  Â  Â  document.getElementById("login").style.display = "block";
Â  Â  Â  document.getElementById("chatFab").style.display Â = "none";
Â  Â  Â  document.getElementById("chatDock").style.display = "none";
Â  Â  };

Â  Â  // Si el usuario quedÃ³ logueado previamente (refresh)
Â  Â  (function autoLoginFromStorage(){
Â  Â  Â  const u = localStorage.getItem("usuarioActual");
Â  Â  Â  const r = localStorage.getItem("rolUsuario");
Â  Â  Â  if(u && r){
Â  Â  Â  Â  currentUser = u;
Â  Â  Â  Â  isAdmin = (r === "admin");
Â  Â  Â  Â  document.getElementById("login").style.display = "none";
Â  Â  Â  Â  document.getElementById("panel").style.display = "block";
Â  Â  Â  Â  const badge = document.getElementById("adminBadge");
Â  Â  Â  Â  if (badge) badge.style.display = isAdmin ? "inline-flex" : "none";
Â  Â  Â  Â  document.getElementById("chatFab").style.display Â = "flex";
Â  Â  Â  Â  document.getElementById("chatDock").style.display = "flex";
Â  Â  Â  Â  initChat();
Â  Â  Â  Â  cargarEnvios();
Â  Â  Â  }
Â  Â  })();

Â  Â  /* ===========================
Â  Â  Â  Â 4) Utilidades
Â  Â  Â  Â =========================== */
Â  Â  function generarCodigo(){ return `LT-${Math.floor(100000 + Math.random()*900000)}` }
Â  Â  function nowStr(){ return new Date().toLocaleString() }

Â  Â  /* ===========================
Â  Â  Â  Â 5) CRUD + Recibo con barras
Â  Â  Â  Â =========================== */
Â  Â  window.guardarEnvio = async function(){
Â  Â  Â  const cliente = document.getElementById("cliente").value.trim();
Â  Â  Â  const destinatario = document.getElementById("destinatario").value.trim();
Â  Â  Â  const destino = document.getElementById("destino").value.trim();
Â  Â  Â  const estado = document.getElementById("estado").value.trim();
Â  Â  Â  const ubicacion = document.getElementById("ubicacion").value.trim();

Â  Â  Â  if(!cliente || !destinatario || !destino || !estado || !ubicacion){
Â  Â  Â  Â  alert("Completa todos los campos."); return;
Â  Â  Â  }
Â  Â  Â  const codigo = generarCodigo();
Â  Â  Â  const payload = {
Â  Â  Â  Â  codigo, cliente, destinatario, destino, estado, ubicacion,
Â  Â  Â  Â  fecha: nowStr(), actualizadoPor: currentUser || "Sistema", registradoPor: currentUser || "Sistema"
Â  Â  Â  };
Â  Â  Â  await setDoc(doc(db,"equipaje",codigo), payload);

Â  Â  Â  // Recibo
Â  Â  Â  const reciboDiv = document.getElementById("recibo");
Â  Â  Â  reciboDiv.innerHTML = `
Â  Â  Â  Â  <div class="container" style="margin-top:16px;border:1px solid var(--border)">
Â  Â  Â  Â  Â  <h3 style="color:var(--primary);margin-top:0">Recibo de EnvÃ­o</h3>
Â  Â  Â  Â  Â  <p><strong>CÃ³digo:</strong> ${codigo}</p>
Â  Â  Â  Â  Â  <p><strong>Cliente:</strong> ${cliente}</p>
Â  Â  Â  Â  Â  <p><strong>Destinatario:</strong> ${destinatario}</p>
Â  Â  Â  Â  Â  <p><strong>Destino:</strong> ${destino}</p>
Â  Â  Â  Â  Â  <p><strong>Estado:</strong> ${estado}</p>
Â  Â  Â  Â  Â  <p><strong>UbicaciÃ³n:</strong> ${ubicacion}</p>
Â  Â  Â  Â  Â  <svg id="codigoBarras"></svg>
Â  Â  Â  Â  Â  <button class="btn" style="margin-top:10px" onclick="window.print()">ğŸ–¨ï¸ Imprimir Recibo</button>
Â  Â  Â  Â  </div>`;
Â  Â  Â  JsBarcode("#codigoBarras", codigo, {format:"CODE128", width:2, height:60, displayValue:true, fontSize:16});

Â  Â  Â  ["cliente","destinatario","destino","estado","ubicacion"].forEach(id => document.getElementById(id).value = "");
Â  Â  Â  await cargarEnvios();
Â  Â  Â  alert("âœ… EnvÃ­o registrado correctamente.");
Â  Â  };

Â  Â  async function cargarEnvios(){
Â  Â  Â  const q = query(collection(db,"equipaje"), orderBy("fecha","desc"));
Â  Â  Â  const qs = await getDocs(q);
Â  Â  Â  registrosEnvios = [];
Â  Â  Â  qs.forEach(docSnap => registrosEnvios.push(docSnap.data()));
Â  Â  Â  mostrarEnvios(registrosEnvios);
Â  Â  Â  document.getElementById("contador").textContent = `ğŸ“¦ ${registrosEnvios.length} envÃ­os cargados`;
Â  Â  }

Â  Â  function renderFila(d){
Â  Â  Â  const editBtn = isAdmin
Â  Â  Â  Â  ? `<button class="btn" onclick="abrirEdicion('${d.codigo}')" title="Editar">âœï¸</button>`
Â  Â  Â  Â  : `<button class="btn" onclick="alert('âš ï¸ No tienes permiso para realizar esta acciÃ³n.')" title="Editar">âœï¸</button>`;
Â  Â  Â  const delBtn Â = `<button class="btn btn-danger" onclick="eliminarRegistro('${d.codigo}')" title="Eliminar">ğŸ—‘ï¸</button>`;
Â  Â  Â  return `
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <td>${d.codigo}</td>
Â  Â  Â  Â  Â  <td>${d.cliente||"â€”"}</td>
Â  Â  Â  Â  Â  <td>${d.destinatario||"â€”"}</td>
Â  Â  Â  Â  Â  <td>${d.destino||"â€”"}</td>
Â  Â  Â  Â  Â  <td>${d.estado||"â€”"}</td>
Â  Â  Â  Â  Â  <td>${d.ubicacion||"â€”"}</td>
Â  Â  Â  Â  Â  <td>${d.fecha||"â€”"}</td>
Â  Â  Â  Â  Â  <td>${d.actualizadoPor||d.registradoPor||"â€”"}</td>
Â  Â  Â  Â  Â  <td>${editBtn} ${delBtn}</td>
Â  Â  Â  Â  </tr>`;
Â  Â  }

Â  Â  function mostrarEnvios(lista){
Â  Â  Â  const body = document.getElementById("tablaBody");
Â  Â  Â  body.innerHTML = "";
Â  Â  Â  lista.forEach(d => body.insertAdjacentHTML("beforeend", renderFila(d)));
Â  Â  Â  registrosFiltrados = [...lista];
Â  Â  Â  document.getElementById("contador").textContent = `ğŸ“¦ ${lista.length} envÃ­os cargados`;
Â  Â  }

Â  Â  window.filtrarEnvios = function(){
Â  Â  Â  const e = document.getElementById("filterEstado").value.toLowerCase();
Â  Â  Â  const lista = (e==="todos") ? registrosEnvios : registrosEnvios.filter(x => (x.estado||"").toLowerCase()===e);
Â  Â  Â  mostrarEnvios(lista);
Â  Â  };

Â  Â  window.eliminarRegistro = async function(codigo){
Â  Â  Â  if(!confirm(`Â¿Eliminar el envÃ­o ${codigo}?`)) return;
Â  Â  Â  await deleteDoc(doc(db,"equipaje",codigo));
Â  Â  Â  await cargarEnvios();
Â  Â  };

Â  Â  /* ===========================
Â  Â  Â  Â 6) EdiciÃ³n (solo Alexs)
Â  Â  Â  Â =========================== */
Â  Â  window.abrirEdicion = async function(codigo){
Â  Â  Â  if(!isAdmin){ alert("âš ï¸ No tienes permiso para realizar esta acciÃ³n."); return; }
Â  Â  Â  const ref = doc(db,"equipaje",codigo);
Â  Â  Â  const snap = await getDoc(ref);
Â  Â  Â  if(!snap.exists()) return alert("Registro no encontrado.");
Â  Â  Â  const d = snap.data();
Â  Â  Â  editingDocId = codigo;
Â  Â  Â  document.getElementById("editCodigo").value = d.codigo||"";
Â  Â  Â  document.getElementById("editCliente").value = d.cliente||"";
Â  Â  Â  document.getElementById("editDestinatario").value = d.destinatario||"";
Â  Â  Â  document.getElementById("editDestino").value = d.destino||"";
Â  Â  Â  document.getElementById("editEstado").value = d.estado||"Recibido en la Oficina";
Â  Â  Â  document.getElementById("editUbicacion").value = d.ubicacion||"";
Â  Â  Â  document.getElementById("editFecha").value = "";
Â  Â  Â  document.getElementById("modalBackdrop").style.display="block";
Â  Â  };
Â  Â  window.cerrarModal = function(){ document.getElementById("modalBackdrop").style.display="none"; };
Â  Â  window.guardarEdicion = async function(){
Â  Â  Â  if(!isAdmin){ alert("âš ï¸ No tienes permiso para realizar esta acciÃ³n."); return; }
Â  Â  Â  const newCode = document.getElementById("editCodigo").value.trim();
Â  Â  Â  const obj = {
Â  Â  Â  Â  codigo:newCode,
Â  Â  Â  Â  cliente:document.getElementById("editCliente").value.trim(),
Â  Â  Â  Â  destinatario:document.getElementById("editDestinatario").value.trim(),
Â  Â  Â  Â  destino:document.getElementById("editDestino").value.trim(),
Â  Â  Â  Â  estado:document.getElementById("editEstado").value,
Â  Â  Â  Â  ubicacion:document.getElementById("editUbicacion").value.trim(),
Â  Â  Â  Â  fecha: (document.getElementById("editFecha").value.trim() || nowStr()),
Â  Â  Â  Â  actualizadoPor: currentUser || "Alexs"
Â  Â  Â  };
Â  Â  Â  if(newCode !== editingDocId){
Â  Â  Â  Â  await setDoc(doc(db,"equipaje",newCode), obj);
Â  Â  Â  Â  await deleteDoc(doc(db,"equipaje",editingDocId));
Â  Â  Â  }else{
Â  Â  Â  Â  await updateDoc(doc(db,"equipaje",editingDocId), obj);
Â  Â  Â  }
Â  Â  Â  cerrarModal();
Â  Â  Â  await cargarEnvios();
Â  Â  };

Â  Â  /* ===========================
Â  Â  Â  Â 7) EscÃ¡ner de estado
Â  Â  Â  Â =========================== */
Â  Â  const scanInput = document.getElementById("scanInput");
Â  Â  scanInput.addEventListener("change", ()=>{
Â  Â  Â  codigoActual = scanInput.value.trim();
Â  Â  Â  if(!codigoActual) return;
Â  Â  Â  document.getElementById("actualizarForm").style.display = "block";
Â  Â  Â  scanInput.value="";
Â  Â  });

Â  Â  window.confirmarActualizacion = async function(){
Â  Â  Â  const nuevoEstado = document.getElementById("nuevoEstado").value;
Â  Â  Â  const nuevaUbicacion = document.getElementById("nuevaUbicacion").value;
Â  Â  Â  if(!codigoActual) return alert("Escanee un cÃ³digo primero.");
Â  Â  Â  if(!nuevoEstado) return alert("Selecciona un estado.");

Â  Â  Â  const ref = doc(db,"equipaje",codigoActual);
Â  Â  Â  const exists = await getDoc(ref);
Â  Â  Â  if(!exists.exists()) return alert("CÃ³digo no encontrado.");

Â  Â  Â  await updateDoc(ref, {
Â  Â  Â  Â  estado:nuevoEstado,
Â  Â  Â  Â  ubicacion:(nuevaUbicacion||"Sin cambios"),
Â  Â  Â  Â  fecha:nowStr(),
Â  Â  Â  Â  actualizadoPor:currentUser||"Sistema"
Â  Â  Â  });
Â  Â  Â  document.getElementById("actualizarForm").style.display="none";
Â  Â  Â  const msg = document.getElementById("mensajeConfirmacion");
Â  Â  Â  msg.style.display="block"; setTimeout(()=>msg.style.display="none", 3200);
Â  Â  Â  cargarEnvios();
Â  Â  };

Â  Â  /* ===========================
Â  Â  Â  Â 8) Exportar / Imprimir
Â  Â  Â  Â =========================== */
Â  Â  window.exportarExcel = function(){
Â  Â  Â  if(registrosFiltrados.length===0) return alert("No hay registros para exportar.");
Â  Â  Â  const hoja = XLSX.utils.json_to_sheet(registrosFiltrados);
Â  Â  Â  const libro = XLSX.utils.book_new();
Â  Â  Â  XLSX.utils.book_append_sheet(libro, hoja, "EnvÃ­os");
Â  Â  Â  const fecha = new Date().toISOString().split("T")[0];
Â  Â  Â  XLSX.writeFile(libro, `LunaTrack_filtrado_${fecha}.xlsx`);
Â  Â  };

Â  Â  window.exportarPDF = function(){
Â  Â  Â  if(registrosFiltrados.length===0) return alert("No hay registros para exportar.");
Â  Â  Â  const { jsPDF } = window.jspdf;
Â  Â  Â  const docPDF = new jsPDF();
Â  Â  Â  docPDF.text("LunaTrack - EnvÃ­os (filtrados)", 14, 15);
Â  Â  Â  const filas = registrosFiltrados.map(d => [d.codigo,d.cliente,d.destinatario,d.destino,d.estado,d.ubicacion,d.fecha,d.actualizadoPor||d.registradoPor||""]);
Â  Â  Â  docPDF.autoTable({ head:[["CÃ³digo","Cliente","Destinatario","Destino","Estado","UbicaciÃ³n","Fecha","Actualizado por"]], body:filas, startY:25 });
Â  Â  Â  const fecha = new Date().toISOString().split("T")[0];
Â  Â  Â  docPDF.save(`LunaTrack_filtrado_${fecha}.pdf`);
Â  Â  };

Â  Â  window.imprimirFiltrado = function(){
Â  Â  Â  if(registrosFiltrados.length===0) return alert("No hay registros para imprimir.");
Â  Â  Â  let w = window.open("", "PRINT", "height=650,width=900,top=100,left=150");
Â  Â  Â  w.document.write(`<html><head><title>Lista filtrada</title><style>
Â  Â  Â  Â  body{font-family:'Inter',sans-serif;padding:16px}
Â  Â  Â  Â  table{width:100%;border-collapse:collapse}
Â  Â  Â  Â  th,td{border:1px solid #ddd;padding:6px;text-align:left}
Â  Â  Â  Â  th{background:#213D7A;color:#fff}
Â  Â  Â  </style></head><body>`);
Â  Â  Â  w.document.write("<h3>Lista filtrada de envÃ­os</h3><table><thead><tr><th>CÃ³digo</th><th>Cliente</th><th>Destinatario</th><th>Destino</th><th>Estado</th><th>UbicaciÃ³n</th><th>Fecha</th><th>Actualizado por</th></tr></thead><tbody>");
Â  Â  Â  registrosFiltrados.forEach(d=>{
Â  Â  Â  Â  w.document.write(`<tr><td>${d.codigo}</td><td>${d.cliente||""}</td><td>${d.destinatario||""}</td><td>${d.destino||""}</td><td>${d.estado||""}</td><td>${d.ubicacion||""}</td><td>${d.fecha||""}</td><td>${d.actualizadoPor||d.registradoPor||""}</td></tr>`);
Â  Â  Â  });
Â  Â  Â  w.document.write("</tbody></table></body></html>");
Â  Â  Â  w.document.close(); w.focus(); w.print(); w.close();
Â  Â  };

Â  Â  /* ===========================
Â  Â  Â  Â 9) Chat del Equipo (dock)
Â  Â  Â  Â =========================== */
Â  Â  let chatUnseen = 0;
Â  Â  let chatOpen = false;
Â  Â  let lastSeenTs = Date.now();

Â  Â  const chatFab Â  = document.getElementById("chatFab");
Â  Â  const chatDock Â = document.getElementById("chatDock");
Â  Â  const chatBadge = document.getElementById("chatBadge");
Â  Â  const chatMsgs Â = document.getElementById("chatMessages");
Â  Â  const chatText Â = document.getElementById("chatText");

Â  Â  const notifSound = new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_9c5f0b7edc.mp3?filename=notification-3-156508.mp3");

Â  Â  chatFab.addEventListener("click", toggleChat);
Â  Â  window.toggleChat = function(){
Â  Â  Â  chatOpen = !chatOpen;
Â  Â  Â  chatDock.classList.toggle("open", chatOpen);
Â  Â  Â  if(chatOpen){
Â  Â  Â  Â  chatUnseen = 0;
Â  Â  Â  Â  chatBadge.style.display="none";
Â  Â  Â  Â  lastSeenTs = Date.now();
Â  Â  Â  Â  scrollChatBottom();
Â  Â  Â  }
Â  Â  };
Â  Â  function scrollChatBottom(){ chatMsgs.scrollTop = chatMsgs.scrollHeight; }

Â  Â  async function initChat(){
Â  Â  Â  // Limpieza >24h
Â  Â  Â  const cutoff = Date.now() - (24*60*60*1000);
Â  Â  Â  const qOld = query(collection(db,"chatInterno"), where("createdAt","<", cutoff));
Â  Â  Â  const snapOld = await getDocs(qOld);
Â  Â  Â  for(const d of snapOld.docs){ await deleteDoc(d.ref); }

Â  Â  Â  // Realtime
Â  Â  Â  const qChat = query(collection(db,"chatInterno"), orderBy("createdAt","asc"));
Â  Â  Â  onSnapshot(qChat, (snap)=>{
Â  Â  Â  Â  chatMsgs.innerHTML = "";
Â  Â  Â  Â  let lastMsg = null;
Â  Â  Â  Â  snap.forEach(docSnap=>{
Â  Â  Â  Â  Â  const m = docSnap.data();
Â  Â  Â  Â  Â  lastMsg = m;
Â  Â  Â  Â  Â  const mine = (m.user===currentUser);
Â  Â  Â  Â  Â  const div = document.createElement("div");
Â  Â  Â  Â  Â  div.className = `msg ${mine? 'mine':'theirs'}`;
Â  Â  Â  Â  Â  div.innerHTML = `<div>${m.text||""}</div><div class="meta">${m.user||"?"} â€¢ ${new Date(m.createdAt||Date.now()).toLocaleTimeString()}</div>`;
Â  Â  Â  Â  Â  chatMsgs.appendChild(div);
Â  Â  Â  Â  Â  if(!chatOpen && (m.createdAt || 0) > lastSeenTs && m.user !== currentUser){
Â  Â  Â  Â  Â  Â  chatUnseen++; chatBadge.style.display="block";
Â  Â  Â  Â  Â  Â  try{ notifSound.currentTime = 0; notifSound.play(); }catch(e){}
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  if(chatOpen) scrollChatBottom();
Â  Â  Â  });
Â  Â  }

Â  Â  window.enviarMensaje = async function(){
Â  Â  Â  const t = chatText.value.trim();
Â  Â  Â  if(!t) return;
Â  Â  Â  await addDoc(collection(db,"chatInterno"), { user: currentUser||"Invitado", text:t, createdAt: Date.now() });
Â  Â  Â  chatText.value=""; scrollChatBottom();
Â  Â  };
Â  </script>

Â  <!-- CÃ³digo de barras -->
Â  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
</body>
</html>
