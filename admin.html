<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Registro - Luna Travel</title>

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Librer√≠as utilitarias -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --primary:#143c8c; --primary-dark:#0f2f6b; --danger:#e74c3c;
      --bg:#f7f9fc; --white:#fff; --border:#e5e7eb;
    }
    body {
      font-family:'Inter',sans-serif;
      background:var(--bg);
      margin:0;
      color:#111;
    }
    .container {
      max-width:980px;
      margin:32px auto;
      background:var(--white);
      padding:28px;
      border-radius:12px;
      box-shadow:0 4px 10px rgba(0,0,0,.1);
    }
    h2 { color:var(--primary); margin:0 0 16px; }
    input,select,button { font-family:inherit; }
    input,select { padding:10px; border:1px solid #ccc; border-radius:8px; width:100%; margin:8px 0; }
    button { background:var(--primary); color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; }
    button:hover { background:var(--primary-dark); }
    .btn-danger { background:var(--danger); }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:720px){ .grid { grid-template-columns:1fr; } }
    .toolbar { display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; margin:14px 0; }

    /* Chat Dock */
    .chat-fab {
      position:fixed; right:20px; bottom:20px;
      background:var(--primary); color:#fff;
      border:none; border-radius:50%; width:56px; height:56px;
      display:none; align-items:center; justify-content:center;
      box-shadow:0 4px 10px rgba(0,0,0,.2);
      cursor:pointer; z-index:9950; font-size:20px;
    }
    .chat-dock {
      position:fixed; top:0; right:-380px; width:360px; height:100vh;
      background:#fff; box-shadow:-4px 0 16px rgba(0,0,0,.15);
      display:flex; flex-direction:column; transition:right .25s ease; z-index:9900;
    }
    .chat-dock.open { right:0; }
    .chat-header {
      background:var(--primary); color:#fff; padding:12px 14px;
      display:flex; justify-content:space-between; align-items:center;
    }
    .chat-messages { flex:1; overflow:auto; padding:12px; background:#f8fafc; }
    .msg { max-width:80%; margin:6px 0; padding:8px 10px; border-radius:10px; }
    .msg.mine { margin-left:auto; background:rgba(20,60,140,.1); border:1px solid #c7d2fe; }
    .msg.theirs { margin-right:auto; background:#e5e7eb; }
    .msg .meta { font-size:11px; color:#555; margin-top:2px; }
    .chat-input { display:flex; gap:8px; padding:10px; border-top:1px solid var(--border); }
    .chat-input input { flex:1; }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div id="login" class="container" style="text-align:center;">
    <h2>Acceso Administrador</h2>
    <div class="grid" style="max-width:420px;margin:0 auto;">
      <input type="text" id="usuario" placeholder="Usuario">
      <input type="password" id="pin" placeholder="PIN">
    </div>
    <button onclick="login()">Ingresar</button>
    <p id="loginError" style="color:#d32f2f;display:none;">Usuario o PIN incorrectos.</p>
  </div>

  <!-- PANEL -->
  <div id="panel" class="container" style="display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <h2>Panel de Registro - Luna Travel
        <span id="adminBadge" style="display:none;padding:4px 10px;border-radius:999px;background:#10b981;color:#fff;font-size:12px;font-weight:700">üîë Admin</span>
      </h2>
      <button onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>
  </div>

  <!-- Chat Interno -->
  <button class="chat-fab" id="chatFab">üí¨</button>
  <div class="chat-dock" id="chatDock">
    <div class="chat-header">
      <strong>Chat del Equipo</strong>
      <button id="cerrarChatBtn" type="button">‚ùå</button>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="chatText" placeholder="Escribe un mensaje...">
      <button id="chatSend" type="button">Enviar</button>
    </div>
  </div>

  <!-- FIREBASE: IMPORTS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, setDoc, updateDoc, deleteDoc, getDoc,
      collection, addDoc, getDocs, onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    window.firebaseLib = { initializeApp, getFirestore, doc, setDoc, updateDoc, deleteDoc, getDoc,
      collection, addDoc, getDocs, onSnapshot, query, orderBy };
  </script>

  <!-- L√ìGICA PRINCIPAL -->
  <script>
    const { initializeApp, getFirestore, doc, setDoc, updateDoc, deleteDoc, getDoc,
            collection, addDoc, getDocs, onSnapshot, query, orderBy } = window.firebaseLib;

    // --- Config Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyBUiJ9u2GyPBovgoaS64r89E1tydCP5Na4",
      authDomain: "lunatrack-95199.firebaseapp.com",
      projectId: "lunatrack-95199",
      storageBucket: "lunatrack-95199.firebasestorage.app",
      messagingSenderId: "82970120947",
      appId: "1:82970120947:web:2d7b70d052816802c05d86"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Variables globales ---
    window.currentUser = null;
    window.isAdmin = false;

    // --- LOGIN ---
    window.login = function() {
      const u = document.getElementById("usuario").value.trim();
      const p = document.getElementById("pin").value.trim();
      const valid = { "Alexs":"2036","Mela":"2006","Amisaday":"1994","Juan":"5304","Ana":"0503" };

      if(valid[u] && valid[u]===p){
        currentUser = u;
        isAdmin = (u==="Alexs");
        localStorage.setItem("usuarioActual", u);
        document.getElementById("login").style.display="none";
        document.getElementById("panel").style.display="block";
        document.getElementById("adminBadge").style.display = isAdmin ? "inline-flex" : "none";
        document.getElementById("chatFab").style.display="flex";
        if(typeof initChat==="function") initChat();
      } else {
        document.getElementById("loginError").style.display="block";
      }
    };

    // --- CERRAR SESI√ìN ---
    window.cerrarSesion = function(){
      localStorage.removeItem("usuarioActual");
      currentUser=null; isAdmin=false;
      document.getElementById("panel").style.display="none";
      document.getElementById("login").style.display="block";
      document.getElementById("chatFab").style.display="none";
      document.getElementById("chatDock").classList.remove("open");
    };

    // --- CHAT DEL EQUIPO ---
    function initChat(){
      const chatFab = document.getElementById("chatFab");
      const chatDock = document.getElementById("chatDock");
      const chatMsgs = document.getElementById("chatMessages");
      const chatText = document.getElementById("chatText");
      const cerrarChatBtn = document.getElementById("cerrarChatBtn");
      const chatSendBtn = document.getElementById("chatSend");

      let chatOpen=false;
      let notifSound=null;

      document.addEventListener("click",()=>{ if(!notifSound){ notifSound=new Audio("https://assets.mixkit.co/sfx/preview/mixkit-notification-bell-590.mp3"); }});

      window.toggleChat=function(){
        chatOpen=!chatOpen;
        chatDock.classList.toggle("open",chatOpen);
        if(chatOpen)setTimeout(()=>chatMsgs.scrollTop=chatMsgs.scrollHeight,200);
      };

      chatFab.onclick=toggleChat;
      cerrarChatBtn.onclick=toggleChat;

      chatSendBtn.onclick=async()=>{
        const text=chatText.value.trim();
        if(!text)return;
        await addDoc(collection(db,"chatInterno"),{
          user:localStorage.getItem("usuarioActual")||currentUser||"Usuario",
          text,createdAt:Date.now()
        });
        chatText.value="";
      };

      onSnapshot(query(collection(db,"chatInterno"),orderBy("createdAt","asc")),(snap)=>{
        chatMsgs.innerHTML="";
        let last=null;
        snap.forEach(docSnap=>{
          const m=docSnap.data(); if(!m.text)return;
          const mine=m.user===(localStorage.getItem("usuarioActual")||currentUser);
          const div=document.createElement("div");
          div.className=`msg ${mine?"mine":"theirs"}`;
          div.innerHTML=`<div>${m.text}</div><div class="meta">${m.user} ‚Ä¢ ${new Date(m.createdAt).toLocaleTimeString()}</div>`;
          chatMsgs.appendChild(div);
          last=m;
        });
        chatMsgs.scrollTop=chatMsgs.scrollHeight;
        if(last && last.user!==(localStorage.getItem("usuarioActual")||currentUser) && !chatOpen){
          try{notifSound.currentTime=0;notifSound.play();}catch(e){}
        }
      });
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
</body>
</html>
