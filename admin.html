<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Registro - Luna Travel</title>

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --primary: #143c8c;
      --primary-dark: #0f2f6b;
      --danger: #e74c3c;
      --bg: #f7f9fc;
      --white: #fff;
    }
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      margin: 0;
      color: #111;
      text-align: center;
    }
    .container {
      max-width: 950px;
      margin: 40px auto;
      background: var(--white);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      text-align: left;
    }
    input, select, button {
      font-family: inherit;
    }
    input, select {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 100%;
      margin: 8px 0;
    }
    button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background-color: var(--primary-dark);
    }
    .btn-danger {
      background-color: var(--danger);
    }
    #tablaEnvios {
      width: 100%;
      margin-top: 25px;
      border-collapse: collapse;
    }
    #tablaEnvios th, #tablaEnvios td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    #tablaEnvios th {
      background-color: var(--primary);
      color: white;
    }
    .logout-btn {
      float: right;
      background-color: #555;
    }
    .logout-btn:hover {
      background-color: #333;
    }
    #login {
      margin-top: 100px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 720px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <!-- LOGIN -->
  <div id="login" class="container" style="text-align:center;">
    <h2>Acceso Administrador</h2>
    <div class="grid" style="max-width:400px;margin:0 auto;">
      <input type="text" id="usuario" placeholder="Usuario (Alexs / Mela / Amisaday / Juan / Ana)">
      <input type="password" id="pin" placeholder="PIN">
    </div>
    <button onclick="login()">Ingresar</button>
    <p id="loginError" style="color:red;display:none;">Usuario o PIN incorrectos.</p>
  </div>

  <!-- PANEL -->
  <div id="panel" class="container" style="display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <h2>Panel de Registro - Luna Travel</h2>
      <button class="logout-btn" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>

    <div class="grid">
      <input type="text" id="cliente" placeholder="Cliente">
      <input type="text" id="destinatario" placeholder="Destinatario (quien recoge)">
      <input type="text" id="destino" placeholder="Destino">
      <select id="estado">
        <option value="">Seleccionar estado...</option>
        <option>Recibido en la Oficina</option>
        <option>En Tr√°nsito</option>
        <option>Procesando para Entrega</option>
        <option>En Reparto</option>
        <option>Entregado</option>
      </select>
      <input type="text" id="ubicacion" placeholder="Ubicaci√≥n">
    </div>

    <button onclick="guardarEnvio()">Guardar y generar recibo</button>
    <div id="recibo"></div>

    <h3>Filtrar y exportar</h3>
    <select id="filterEstado" onchange="filtrarEnvios()">
      <option value="todos">Todos</option>
      <option value="recibido en la oficina">Recibido en la Oficina</option>
      <option value="en tr√°nsito">En Tr√°nsito</option>
      <option value="procesando para entrega">Procesando para Entrega</option>
      <option value="en reparto">En Reparto</option>
      <option value="entregado">Entregado</option>
    </select>
    <button onclick="exportarExcel()">üì§ Exportar Excel</button>
    <button onclick="exportarPDF()">üßæ Exportar PDF</button>

    <table id="tablaEnvios">
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Cliente</th>
          <th>Destinatario</th>
          <th>Destino</th>
          <th>Estado</th>
          <th>Ubicaci√≥n</th>
          <th>Fecha</th>
          <th>Actualizado por</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaBody"></tbody>
    </table>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc,
      collection, getDocs, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUiJ9u2GyPBovgoaS64r89E1tydCP5Na4",
      authDomain: "lunatrack-95199.firebaseapp.com",
      projectId: "lunatrack-95199",
      storageBucket: "lunatrack-95199.firebasestorage.app",
      messagingSenderId: "82970120947",
      appId: "1:82970120947:web:2d7b70d052816802c05d86",
      measurementId: "G-QCYKV5DXKD"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUser = "";
    let isAdmin = false;

    window.login = function () {
      const u = document.getElementById("usuario").value.trim();
      const p = document.getElementById("pin").value.trim();
      const valid = {
        "Alexs": "2036",
        "Mela": "2006",
        "Amisaday": "1994",
        "Juan": "5304",
        "Ana": "0503"
      };
      if (valid[u] && valid[u] === p) {
        currentUser = u;
        isAdmin = (u === "Alexs");
        document.getElementById("login").style.display = "none";
        document.getElementById("panel").style.display = "block";
        localStorage.setItem("usuarioActual", u);
        cargarEnvios();
        iniciarCrisp(); // üëà Carga Crisp solo tras login
      } else {
        document.getElementById("loginError").style.display = "block";
      }
    };

    window.cerrarSesion = function () {
      document.getElementById("panel").style.display = "none";
      document.getElementById("login").style.display = "block";
      currentUser = "";
      localStorage.removeItem("usuarioActual");
      if (window.$crisp) window.$crisp.push(["do", "chat:close"]);
    };

    function generarCodigo() {
      return `LT-${Math.floor(100000 + Math.random() * 900000)}`;
    }

    window.guardarEnvio = async function () {
      const cliente = document.getElementById("cliente").value.trim();
      const destinatario = document.getElementById("destinatario").value.trim();
      const destino = document.getElementById("destino").value.trim();
      const estado = document.getElementById("estado").value.trim();
      const ubicacion = document.getElementById("ubicacion").value.trim();
      if (!cliente || !destinatario || !destino || !estado || !ubicacion) {
        alert("Completa todos los campos.");
        return;
      }
      const codigo = generarCodigo();
      await setDoc(doc(db, "equipaje", codigo), {
        codigo, cliente, destinatario, destino, estado, ubicacion,
        fecha: new Date().toLocaleString(),
        actualizadoPor: currentUser
      });
      mostrarRecibo(codigo, cliente, destinatario, destino, estado, ubicacion);
      cargarEnvios();
    };

    function mostrarRecibo(codigo, cliente, destinatario, destino, estado, ubicacion) {
      document.getElementById("recibo").innerHTML = `
        <div class="container">
          <h3>Recibo de Env√≠o</h3>
          <p><strong>C√≥digo:</strong> ${codigo}</p>
          <p><strong>Cliente:</strong> ${cliente}</p>
          <p><strong>Destinatario:</strong> ${destinatario}</p>
          <p><strong>Destino:</strong> ${destino}</p>
          <p><strong>Estado:</strong> ${estado}</p>
          <p><strong>Ubicaci√≥n:</strong> ${ubicacion}</p>
          <svg id="codigoBarras"></svg>
          <button onclick="window.print()">üñ®Ô∏è Imprimir Recibo</button>
        </div>`;
      JsBarcode("#codigoBarras", codigo, { format: "CODE128", width: 2, height: 60, displayValue: true });
    }

    async function cargarEnvios() {
      const q = query(collection(db, "equipaje"), orderBy("fecha", "desc"));
      const snap = await getDocs(q);
      const body = document.getElementById("tablaBody");
      body.innerHTML = "";
      snap.forEach(docSnap => {
        const d = docSnap.data();
        body.innerHTML += `
          <tr>
            <td>${d.codigo}</td>
            <td>${d.cliente}</td>
            <td>${d.destinatario}</td>
            <td>${d.destino}</td>
            <td>${d.estado}</td>
            <td>${d.ubicacion}</td>
            <td>${d.fecha}</td>
            <td>${d.actualizadoPor}</td>
            <td><button class="btn-danger" onclick="eliminarRegistro('${d.codigo}')">Eliminar</button></td>
          </tr>`;
      });
    }

    window.eliminarRegistro = async function (codigo) {
      if (!confirm(`¬øEliminar el env√≠o ${codigo}?`)) return;
      await deleteDoc(doc(db, "equipaje", codigo));
      cargarEnvios();
    };

    // ‚úÖ CRISP SOLO DESPU√âS DE LOGIN
    function iniciarCrisp() {
      if (window.$crisp) return;
      window.$crisp = [];
      window.CRISP_WEBSITE_ID = "b1b5252d-d1d1-4845-9575-895f7bcdd7ee";
      (function () {
        var d = document;
        var s = d.createElement("script");
        s.src = "https://client.crisp.chat/l.js";
        s.async = 1;
        d.getElementsByTagName("head")[0].appendChild(s);
      })();
      setTimeout(() => {
        window.$crisp.push(["do", "message:show", ["text", `üëã Hola ${currentUser}, bienvenido al panel Luna Travel.`]]);
      }, 2500);
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
</body>
</html>
