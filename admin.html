<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administraci√≥n - Luna Travel</title>
  <link rel="stylesheet" href="css/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, doc, setDoc, getDoc, updateDoc, 
      collection, getDocs, onSnapshot, query, orderBy 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUiJ9u2GyPBovgoaS64r89E1tydCP5Na4",
      authDomain: "lunatrack-95199.firebaseapp.com",
      projectId: "lunatrack-95199",
      storageBucket: "lunatrack-95199.firebasestorage.app",
      messagingSenderId: "82970120947",
      appId: "1:82970120947:web:2d7b70d052816802c05d86",
      measurementId: "G-QCYKV5DXKD"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // üîê Verificaci√≥n de login
    window.onload = function() {
      if (localStorage.getItem("adminLoggedIn") !== "true") {
        window.location.href = "admin-login.html";
      } else {
        cargarEnvios();
      }
    };

    // üö™ Cerrar sesi√≥n
    window.logout = function() {
      localStorage.removeItem("adminLoggedIn");
      window.location.href = "admin-login.html";
    };

    // üÜï Generar c√≥digo √∫nico
    window.generarCodigo = function() {
      const timestamp = Date.now().toString().slice(-6);
      return "LT-" + timestamp;
    };

    // üßæ Registrar nuevo env√≠o
    window.registrarEquipaje = async function() {
      const cliente = document.getElementById("cliente").value.trim();
      const destino = document.getElementById("destino").value.trim();
      const estado = document.getElementById("estado").value.trim();
      const ubicacion = document.getElementById("ubicacion").value.trim();

      if (!cliente || !destino || !estado || !ubicacion) {
        alert("Por favor completa todos los campos.");
        return;
      }

      const codigo = generarCodigo();

      try {
        await setDoc(doc(db, "equipaje", codigo), {
          codigo,
          cliente,
          destino,
          estado,
          ubicacion,
          fecha: new Date().toLocaleString()
        });

        mostrarRecibo(codigo, cliente, destino, estado, ubicacion);
        alert("‚úÖ Env√≠o registrado correctamente.");
      } catch (error) {
        console.error("Error al guardar:", error);
        alert("Hubo un error al registrar el equipaje.");
      }
    };

    // üîÑ Actualizar estado escaneando
    window.actualizarEstado = async function() {
      const codigo = document.getElementById("codigoEscaneado").value.trim();
      const nuevoEstado = document.getElementById("nuevoEstado").value.trim();
      const nuevaUbicacion = document.getElementById("nuevaUbicacion").value.trim();

      if (!codigo || !nuevoEstado) {
        alert("Por favor ingresa el c√≥digo y el nuevo estado.");
        return;
      }

      try {
        const docRef = doc(db, "equipaje", codigo);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          await updateDoc(docRef, {
            estado: nuevoEstado,
            ubicacion: nuevaUbicacion || docSnap.data().ubicacion,
            fecha: new Date().toLocaleString()
          });
          alert(`‚úÖ Estado actualizado para ${codigo}`);
        } else {
          alert("No se encontr√≥ ning√∫n env√≠o con ese c√≥digo.");
        }
      } catch (error) {
        console.error("Error al actualizar:", error);
      }
    };

    // üñ®Ô∏è Mostrar recibo con c√≥digo de barras
    window.mostrarRecibo = function(codigo, cliente, destino, estado, ubicacion) {
      const reciboDiv = document.getElementById("recibo");
      reciboDiv.innerHTML = `
        <h2>Recibo de Env√≠o</h2>
        <p><strong>C√≥digo:</strong> ${codigo}</p>
        <p><strong>Cliente:</strong> ${cliente}</p>
        <p><strong>Destino:</strong> ${destino}</p>
        <p><strong>Estado:</strong> ${estado}</p>
        <p><strong>Ubicaci√≥n:</strong> ${ubicacion}</p>
        <svg id="codigoBarras"></svg>
        <button onclick="window.print()" class="btn-primary">üñ®Ô∏è Imprimir Recibo</button>
      `;
      JsBarcode("#codigoBarras", codigo, {
        format: "CODE128",
        width: 2,
        height: 60,
        displayValue: true,
        fontSize: 16,
        lineColor: "#000000"
      });
    };

    // üìã Cargar todos los env√≠os
    async function cargarEnvios() {
      const tabla = document.getElementById("tablaEnvios");
      tabla.innerHTML = "<tr><th>C√≥digo</th><th>Cliente</th><th>Destino</th><th>Estado</th><th>Ubicaci√≥n</th><th>Fecha</th></tr>";

      const q = query(collection(db, "equipaje"), orderBy("fecha", "desc"));
      onSnapshot(q, (snapshot) => {
        tabla.innerHTML = "<tr><th>C√≥digo</th><th>Cliente</th><th>Destino</th><th>Estado</th><th>Ubicaci√≥n</th><th>Fecha</th></tr>";
        snapshot.forEach((doc) => {
          const data = doc.data();
          const fila = `
            <tr>
              <td><strong>${data.codigo}</strong></td>
              <td>${data.cliente}</td>
              <td>${data.destino}</td>
              <td>${data.estado}</td>
              <td>${data.ubicacion}</td>
              <td>${data.fecha}</td>
            </tr>
          `;
          tabla.innerHTML += fila;
        });
      });
    }

    window.refrescarTabla = cargarEnvios;
  </script>

  <style>
    body { font-family: Arial, sans-serif; background: #f9fbff; color: #222; padding: 20px; text-align:center; }
    .form-container { max-width: 500px; margin: 30px auto; padding: 20px; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    input, button { width: 100%; padding: 10px; margin: 8px 0; border-radius: 5px; border: 1px solid #ccc; }
    button { background-color: #1a3d8f; color: white; cursor: pointer; border: none; }
    button:hover { background-color: #162f70; }
    #recibo { max-width: 500px; margin: 40px auto; padding: 20px; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
    .logout { position: fixed; top: 20px; right: 20px; background-color: #c0392b; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #1a3d8f; color: white; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    @media print { button, .logout { display: none; } body { background: white; } #recibo { box-shadow: none; } }
  </style>
</head>

<body>
  <button class="logout" onclick="logout()">Cerrar Sesi√≥n</button>

  <h1 style="color:#1a3d8f;">Panel Administrativo - Luna Travel</h1>

  <!-- Registro -->
  <div class="form-container">
    <h3>Registrar nuevo env√≠o</h3>
    <input type="text" id="cliente" placeholder="Nombre del cliente" />
    <input type="text" id="destino" placeholder="Destino" />
    <input type="text" id="estado" placeholder="Estado (ej. En tr√°nsito)" />
    <input type="text" id="ubicacion" placeholder="Ubicaci√≥n (ej. Oficina)" />
    <button onclick="registrarEquipaje()">Guardar y generar recibo</button>
  </div>

  <!-- Recibo -->
  <div id="recibo"></div>

  <!-- Actualizar estado -->
  <div class="form-container">
    <h3>Actualizar estado (con esc√°ner o manual)</h3>
    <input type="text" id="codigoEscaneado" placeholder="Escanear o ingresar c√≥digo LT-" />
    <input type="text" id="nuevoEstado" placeholder="Nuevo estado" />
    <input type="text" id="nuevaUbicacion" placeholder="Nueva ubicaci√≥n (opcional)" />
    <button onclick="actualizarEstado()">Actualizar Estado</button>
  </div>

  <!-- Tabla de control -->
  <div class="form-container" style="max-width:90%;">
<h3>üìã Env√≠os procesados</h3>
<div style="margin-bottom:10px;">
  <button onclick="refrescarTabla()">üîÑ Refrescar</button>
  <button onclick="exportarExcel()">üìä Exportar a Excel</button>
  <button onclick="exportarPDF()">üìÑ Exportar a PDF</button>
</div>
<table id="tablaEnvios">

      <tr><th>C√≥digo</th><th>Cliente</th><th>Destino</th><th>Estado</th><th>Ubicaci√≥n</th><th>Fecha</th></tr>
    </table>
  </div>
</body>
</html>
