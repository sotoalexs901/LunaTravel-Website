<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Registro - Luna Travel</title>

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Librer√≠as utilitarias -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --primary: #143c8c;
      --primary-dark: #0f2f6b;
      --danger: #e74c3c;
      --bg: #f7f9fc;
      --white: #fff;
      --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Inter", sans-serif;
      background: var(--bg);
      margin: 0;
      color: #111;
    }
    .container {
      max-width: 980px;
      margin: 32px auto;
      background: var(--white);
      padding: 28px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    h2 { color: var(--primary); margin: 0 0 16px; }
    input, select, button { font-family: inherit; }
    input, select {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 100%;
      margin: 8px 0;
    }
    button {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover { background: var(--primary-dark); }
    .btn-danger { background: var(--danger); }
    .btn-muted { background: #6b7280; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }
    .toolbar { display: flex; flex-wrap: wrap; justify-content: space-between; margin: 14px 0; gap: 10px; }

    /* Chat Dock */
    .chat-fab {
      position: fixed;
      right: 20px;
      bottom: 20px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      z-index: 9950;
      font-size: 20px;
    }
    .chat-dock {
      position: fixed;
      top: 0;
      right: -380px;
      width: 360px;
      height: 100vh;
      background: #fff;
      box-shadow: -4px 0 16px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      transition: right 0.25s ease;
      z-index: 9900;
    }
    .chat-dock.open { right: 0; }
    .chat-header {
      background: var(--primary);
      color: #fff;
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-messages { flex: 1; overflow: auto; padding: 12px; background: #f8fafc; }
    .msg { max-width: 80%; margin: 6px 0; padding: 8px 10px; border-radius: 10px; }
    .msg.mine { margin-left: auto; background: rgba(20, 60, 140, 0.1); border: 1px solid #c7d2fe; }
    .msg.theirs { margin-right: auto; background: #e5e7eb; }
    .msg .meta { font-size: 11px; color: #555; margin-top: 2px; }
    .chat-input { display: flex; gap: 8px; padding: 10px; border-top: 1px solid var(--border); }
    .chat-input input { flex: 1; }

    @media (max-width: 600px) {
      .chat-dock { width: 100%; right: -100%; }
      .chat-dock.open { right: 0; }
      .chat-fab { bottom: 15px; right: 15px; }
    }
  </style>
</head>

<body>
  <!-- LOGIN -->
  <div id="login" class="container" style="text-align: center;">
    <h2>Acceso Administrador</h2>
    <div class="grid" style="max-width: 420px; margin: 0 auto;">
      <input type="text" id="usuario" placeholder="Usuario" />
      <input type="password" id="pin" placeholder="PIN" />
    </div>
    <button onclick="login()">Ingresar</button>
    <p id="loginError" style="color: #d32f2f; display: none;">Usuario o PIN incorrectos.</p>
  </div>

  <!-- PANEL PRINCIPAL -->
  <div id="panel" class="container" style="display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h2>
        Panel de Registro - Luna Travel
        <span id="adminBadge" style="display:none; padding:4px 10px; border-radius:999px; background:#10b981; color:#fff; font-size:12px; font-weight:700">üîë Admin</span>
      </h2>
      <button onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>

    <!-- Filtros y Export -->
    <div class="toolbar">
      <div>
        <label for="filterEstado" style="font-weight:700;color:var(--primary);">Filtrar por estado:</label>
        <select id="filterEstado" onchange="filtrarEnvios()">
          <option value="todos">Todos</option>
          <option value="recibido en la oficina">Recibido en la Oficina</option>
          <option value="en tr√°nsito">En Tr√°nsito</option>
          <option value="procesando para entrega">Procesando para Entrega</option>
          <option value="en reparto">En Reparto</option>
          <option value="entregado">Entregado</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="exportarExcel()">üì§ Excel</button>
        <button style="background:#c62828" onclick="exportarPDF()">üßæ PDF</button>
        <button class="btn-muted" onclick="imprimirFiltrado()">üñ®Ô∏è Imprimir</button>
      </div>
    </div>

    <!-- Tabla -->
    <h3 style="margin:18px 0 6px;">Env√≠os registrados</h3>
    <p id="contador">üì¶ 0 env√≠os cargados</p>
    <table id="tablaEnvios" style="width:100%;border-collapse:collapse;">
      <thead>
        <tr style="background:var(--primary);color:#fff;">
          <th>C√≥digo</th><th>Cliente</th><th>Destinatario</th><th>Destino</th><th>Estado</th><th>Ubicaci√≥n</th><th>Fecha</th><th>Actualizado por</th>
        </tr>
      </thead>
      <tbody id="tablaBody"></tbody>
    </table>
  </div>

  <!-- CHAT -->
  <button class="chat-fab" id="chatFab">üí¨</button>
  <div class="chat-dock" id="chatDock">
    <div class="chat-header">
      <strong>Chat del Equipo</strong>
      <button id="cerrarChatBtn" type="button">‚ùå</button>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="chatText" placeholder="Escribe un mensaje..." />
      <button id="chatSend" type="button">Enviar</button>
    </div>
  </div>

  <!-- FIREBASE: IMPORT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, updateDoc, deleteDoc, getDoc, collection, addDoc, getDocs, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    window.firebaseLib = { initializeApp, getFirestore, doc, setDoc, updateDoc, deleteDoc, getDoc, collection, addDoc, getDocs, onSnapshot, query, orderBy };
  </script>

  <!-- L√ìGICA -->
  <script>
    const { initializeApp, getFirestore, doc, setDoc, updateDoc, deleteDoc, getDoc, collection, addDoc, getDocs, onSnapshot, query, orderBy } = window.firebaseLib;

    const firebaseConfig = {
      apiKey: "AIzaSyBUiJ9u2GyPBovgoaS64r89E1tydCP5Na4",
      authDomain: "lunatrack-95199.firebaseapp.com",
      projectId: "lunatrack-95199",
      storageBucket: "lunatrack-95199.firebasestorage.app",
      messagingSenderId: "82970120947",
      appId: "1:82970120947:web:2d7b70d052816802c05d86"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let registrosEnvios = [], registrosFiltrados = [];

    const nowStr = () => new Date().toLocaleString();
    const genCode = () => `LT-${Math.floor(100000 + Math.random() * 900000)}`;

    window.login = function() {
      const u = document.getElementById("usuario").value.trim();
      const p = document.getElementById("pin").value.trim();
      const valid = { "Alexs": "2036", "Mela": "2006", "Amisaday": "1994", "Juan": "5304", "Ana": "0503" };

      if (valid[u] && valid[u] === p) {
        localStorage.setItem("usuarioActual", u);
        document.getElementById("login").style.display = "none";
        document.getElementById("panel").style.display = "block";
        document.getElementById("chatFab").style.display = "flex";
        if (u === "Alexs") document.getElementById("adminBadge").style.display = "inline-flex";
        cargarEnvios(); initChat();
      } else {
        document.getElementById("loginError").style.display = "block";
      }
    };

    window.cerrarSesion = function() {
      localStorage.clear();
      document.getElementById("panel").style.display = "none";
      document.getElementById("login").style.display = "block";
      document.getElementById("chatFab").style.display = "none";
      document.getElementById("chatDock").classList.remove("open");
    };

    // Persistencia
    window.onload = () => {
      const user = localStorage.getItem("usuarioActual");
      if (user) {
        document.getElementById("login").style.display = "none";
        document.getElementById("panel").style.display = "block";
        document.getElementById("chatFab").style.display = "flex";
        if (user === "Alexs") document.getElementById("adminBadge").style.display = "inline-flex";
        cargarEnvios(); initChat();
      }
    };

    // Cargar env√≠os
    async function cargarEnvios() {
      const q = query(collection(db, "equipaje"), orderBy("fecha", "desc"));
      const qs = await getDocs(q);
      registrosEnvios = [];
      qs.forEach(s => registrosEnvios.push(s.data()));
      mostrarEnvios(registrosEnvios);
      document.getElementById("contador").textContent = `üì¶ ${registrosEnvios.length} env√≠os cargados`;
    }

    function mostrarEnvios(lista) {
      const body = document.getElementById("tablaBody");
      body.innerHTML = "";
      lista.forEach(d => {
        body.innerHTML += `<tr>
          <td>${d.codigo}</td><td>${d.cliente}</td><td>${d.destinatario}</td>
          <td>${d.destino}</td><td>${d.estado}</td><td>${d.ubicacion}</td><td>${d.fecha}</td>
          <td>${d.actualizadoPor || d.registradoPor}</td></tr>`;
      });
    }

    window.filtrarEnvios = function() {
      const e = document.getElementById("filterEstado").value.toLowerCase();
      const lista = (e === "todos") ? registrosEnvios : registrosEnvios.filter(x => (x.estado || "").toLowerCase() === e);
      mostrarEnvios(lista);
    };

    // Exportar Excel
    window.exportarExcel = function() {
      if (registrosEnvios.length === 0) return alert("No hay registros.");
      const hoja = XLSX.utils.json_to_sheet(registrosEnvios);
      const libro = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(libro, hoja, "Env√≠os");
      XLSX.writeFile(libro, "LunaTrack_Export.xlsx");
    };

    // Exportar PDF
    window.exportarPDF = function() {
      const { jsPDF } = window.jspdf;
      const docPDF = new jsPDF();
      docPDF.text("LunaTrack - Env√≠os", 14, 15);
      const filas = registrosEnvios.map(d => [d.codigo, d.cliente, d.destinatario, d.destino, d.estado, d.ubicacion, d.fecha]);
      docPDF.autoTable({ head: [["C√≥digo", "Cliente", "Destinatario", "Destino", "Estado", "Ubicaci√≥n", "Fecha"]], body: filas, startY: 25 });
      docPDF.save("LunaTrack_Export.pdf");
    };

    // Chat interno
    function initChat() {
      const chatFab = document.getElementById("chatFab");
      const chatDock = document.getElementById("chatDock");
      const chatMsgs = document.getElementById("chatMessages");
      const chatText = document.getElementById("chatText");
      const cerrarChatBtn = document.getElementById("cerrarChatBtn");
      const chatSendBtn = document.getElementById("chatSend");
      let chatOpen = false;
      let notifSound = null;

      document.addEventListener("click", () => { if (!notifSound) notifSound = new Audio("https://assets.mixkit.co/sfx/preview/mixkit-notification-bell-590.mp3"); });

      window.toggleChat = function() {
        chatOpen = !chatOpen;
        chatDock.classList.toggle("open", chatOpen);
        if (chatOpen) setTimeout(() => chatMsgs.scrollTop = chatMsgs.scrollHeight, 200);
      };

      chatFab.onclick = toggleChat;
      cerrarChatBtn.onclick = toggleChat;

      chatSendBtn.onclick = async () => {
        const text = chatText.value.trim();
        if (!text) return;
        await addDoc(collection(db, "chatInterno"), { user: localStorage.getItem("usuarioActual"), text, createdAt: Date.now() });
        chatText.value = "";
      };

      onSnapshot(query(collection(db, "chatInterno"), orderBy("createdAt", "asc")), snap => {
        chatMsgs.innerHTML = "";
        let last = null;
        snap.forEach(docSnap => {
          const m = docSnap.data();
          const mine = m.user === localStorage.getItem("usuarioActual");
          const div = document.createElement("div");
          div.className = `msg ${mine ? "mine" : "theirs"}`;
          div.innerHTML = `<div>${m.text}</div><div class="meta">${m.user} ‚Ä¢ ${new Date(m.createdAt).toLocaleTimeString()}</div>`;
          chatMsgs.appendChild(div);
          last = m;
        });
        chatMsgs.scrollTop = chatMsgs.scrollHeight;
        if (last && last.user !== localStorage.getItem("usuarioActual") && !chatOpen) {
          try { notifSound.currentTime = 0; notifSound.play(); } catch (e) {}
        }
      });
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Registro - Luna Travel</title>

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Librer√≠as utilitarias -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --primary: #143c8c;
      --primary-dark: #0f2f6b;
      --danger: #e74c3c;
      --bg: #f7f9fc;
      --white: #fff;
      --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Inter", sans-serif;
      background: var(--bg);
      margin: 0;
      color: #111;
    }
    .container {
      max-width: 980px;
      margin: 32px auto;
      background: var(--white);
      padding: 28px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    h2 { color: var(--primary); margin: 0 0 16px; }
    input, select, button { font-family: inherit; }
    input, select {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 100%;
      margin: 8px 0;
    }
    button {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover { background: var(--primary-dark); }
    .btn-danger { background: var(--danger); }
    .btn-muted { background: #6b7280; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }
    .toolbar { display: flex; flex-wrap: wrap; justify-content: space-between; margin: 14px 0; gap: 10px; }

    /* Chat Dock */
    .chat-fab {
      position: fixed;
      right: 20px;
      bottom: 20px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      z-index: 9950;
      font-size: 20px;
    }
    .chat-dock {
      position: fixed;
      top: 0;
      right: -380px;
      width: 360px;
      height: 100vh;
      background: #fff;
      box-shadow: -4px 0 16px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      transition: right 0.25s ease;
      z-index: 9900;
    }
    .chat-dock.open { right: 0; }
    .chat-header {
      background: var(--primary);
      color: #fff;
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-messages { flex: 1; overflow: auto; padding: 12px; background: #f8fafc; }
    .msg { max-width: 80%; margin: 6px 0; padding: 8px 10px; border-radius: 10px; }
    .msg.mine { margin-left: auto; background: rgba(20, 60, 140, 0.1); border: 1px solid #c7d2fe; }
    .msg.theirs { margin-right: auto; background: #e5e7eb; }
    .msg .meta { font-size: 11px; color: #555; margin-top: 2px; }
    .chat-input { display: flex; gap: 8px; padding: 10px; border-top: 1px solid var(--border); }
    .chat-input input { flex: 1; }

    @media (max-width: 600px) {
      .chat-dock { width: 100%; right: -100%; }
      .chat-dock.open { right: 0; }
      .chat-fab { bottom: 15px; right: 15px; }
    }
  </style>
</head>

<body>
  <!-- LOGIN -->
  <div id="login" class="container" style="text-align: center;">
    <h2>Acceso Administrador</h2>
    <div class="grid" style="max-width: 420px; margin: 0 auto;">
      <input type="text" id="usuario" placeholder="Usuario" />
      <input type="password" id="pin" placeholder="PIN" />
    </div>
    <button onclick="login()">Ingresar</button>
    <p id="loginError" style="color: #d32f2f; display: none;">Usuario o PIN incorrectos.</p>
  </div>

  <!-- PANEL PRINCIPAL -->
  <div id="panel" class="container" style="display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h2>
        Panel de Registro - Luna Travel
        <span id="adminBadge" style="display:none; padding:4px 10px; border-radius:999px; background:#10b981; color:#fff; font-size:12px; font-weight:700">üîë Admin</span>
      </h2>
      <button onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>

    <!-- Filtros y Export -->
    <div class="toolbar">
      <div>
        <label for="filterEstado" style="font-weight:700;color:var(--primary);">Filtrar por estado:</label>
        <select id="filterEstado" onchange="filtrarEnvios()">
          <option value="todos">Todos</option>
          <option value="recibido en la oficina">Recibido en la Oficina</option>
          <option value="en tr√°nsito">En Tr√°nsito</option>
          <option value="procesando para entrega">Procesando para Entrega</option>
          <option value="en reparto">En Reparto</option>
          <option value="entregado">Entregado</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="exportarExcel()">üì§ Excel</button>
        <button style="background:#c62828" onclick="exportarPDF()">üßæ PDF</button>
        <button class="btn-muted" onclick="imprimirFiltrado()">üñ®Ô∏è Imprimir</button>
      </div>
    </div>

    <!-- Tabla -->
    <h3 style="margin:18px 0 6px;">Env√≠os registrados</h3>
    <p id="contador">üì¶ 0 env√≠os cargados</p>
    <table id="tablaEnvios" style="width:100%;border-collapse:collapse;">
      <thead>
        <tr style="background:var(--primary);color:#fff;">
          <th>C√≥digo</th><th>Cliente</th><th>Destinatario</th><th>Destino</th><th>Estado</th><th>Ubicaci√≥n</th><th>Fecha</th><th>Actualizado por</th>
        </tr>
      </thead>
      <tbody id="tablaBody"></tbody>
    </table>
  </div>

  <!-- CHAT -->
  <button class="chat-fab" id="chatFab">üí¨</button>
  <div class="chat-dock" id="chatDock">
    <div class="chat-header">
      <strong>Chat del Equipo</strong>
      <button id="cerrarChatBtn" type="button">‚ùå</button>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="chatText" placeholder="Escribe un mensaje..." />
      <button id="chatSend" type="button">Enviar</button>
    </div>
  </div>

  <!-- FIREBASE: IMPORT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, updateDoc, deleteDoc, getDoc, collection, addDoc, getDocs, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    window.firebaseLib = { initializeApp, getFirestore, doc, setDoc, updateDoc, deleteDoc, getDoc, collection, addDoc, getDocs, onSnapshot, query, orderBy };
  </script>

  <!-- L√ìGICA -->
  <script>
    const { initializeApp, getFirestore, doc, setDoc, updateDoc, deleteDoc, getDoc, collection, addDoc, getDocs, onSnapshot, query, orderBy } = window.firebaseLib;

    const firebaseConfig = {
      apiKey: "AIzaSyBUiJ9u2GyPBovgoaS64r89E1tydCP5Na4",
      authDomain: "lunatrack-95199.firebaseapp.com",
      projectId: "lunatrack-95199",
      storageBucket: "lunatrack-95199.firebasestorage.app",
      messagingSenderId: "82970120947",
      appId: "1:82970120947:web:2d7b70d052816802c05d86"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let registrosEnvios = [], registrosFiltrados = [];

    const nowStr = () => new Date().toLocaleString();
    const genCode = () => `LT-${Math.floor(100000 + Math.random() * 900000)}`;

    window.login = function() {
      const u = document.getElementById("usuario").value.trim();
      const p = document.getElementById("pin").value.trim();
      const valid = { "Alexs": "2036", "Mela": "2006", "Amisaday": "1994", "Juan": "5304", "Ana": "0503" };

      if (valid[u] && valid[u] === p) {
        localStorage.setItem("usuarioActual", u);
        document.getElementById("login").style.display = "none";
        document.getElementById("panel").style.display = "block";
        document.getElementById("chatFab").style.display = "flex";
        if (u === "Alexs") document.getElementById("adminBadge").style.display = "inline-flex";
        cargarEnvios(); initChat();
      } else {
        document.getElementById("loginError").style.display = "block";
      }
    };

    window.cerrarSesion = function() {
      localStorage.clear();
      document.getElementById("panel").style.display = "none";
      document.getElementById("login").style.display = "block";
      document.getElementById("chatFab").style.display = "none";
      document.getElementById("chatDock").classList.remove("open");
    };

    // Persistencia
    window.onload = () => {
      const user = localStorage.getItem("usuarioActual");
      if (user) {
        document.getElementById("login").style.display = "none";
        document.getElementById("panel").style.display = "block";
        document.getElementById("chatFab").style.display = "flex";
        if (user === "Alexs") document.getElementById("adminBadge").style.display = "inline-flex";
        cargarEnvios(); initChat();
      }
    };

    // Cargar env√≠os
    async function cargarEnvios() {
      const q = query(collection(db, "equipaje"), orderBy("fecha", "desc"));
      const qs = await getDocs(q);
      registrosEnvios = [];
      qs.forEach(s => registrosEnvios.push(s.data()));
      mostrarEnvios(registrosEnvios);
      document.getElementById("contador").textContent = `üì¶ ${registrosEnvios.length} env√≠os cargados`;
    }

    function mostrarEnvios(lista) {
      const body = document.getElementById("tablaBody");
      body.innerHTML = "";
      lista.forEach(d => {
        body.innerHTML += `<tr>
          <td>${d.codigo}</td><td>${d.cliente}</td><td>${d.destinatario}</td>
          <td>${d.destino}</td><td>${d.estado}</td><td>${d.ubicacion}</td><td>${d.fecha}</td>
          <td>${d.actualizadoPor || d.registradoPor}</td></tr>`;
      });
    }

    window.filtrarEnvios = function() {
      const e = document.getElementById("filterEstado").value.toLowerCase();
      const lista = (e === "todos") ? registrosEnvios : registrosEnvios.filter(x => (x.estado || "").toLowerCase() === e);
      mostrarEnvios(lista);
    };

    // Exportar Excel
    window.exportarExcel = function() {
      if (registrosEnvios.length === 0) return alert("No hay registros.");
      const hoja = XLSX.utils.json_to_sheet(registrosEnvios);
      const libro = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(libro, hoja, "Env√≠os");
      XLSX.writeFile(libro, "LunaTrack_Export.xlsx");
    };

    // Exportar PDF
    window.exportarPDF = function() {
      const { jsPDF } = window.jspdf;
      const docPDF = new jsPDF();
      docPDF.text("LunaTrack - Env√≠os", 14, 15);
      const filas = registrosEnvios.map(d => [d.codigo, d.cliente, d.destinatario, d.destino, d.estado, d.ubicacion, d.fecha]);
      docPDF.autoTable({ head: [["C√≥digo", "Cliente", "Destinatario", "Destino", "Estado", "Ubicaci√≥n", "Fecha"]], body: filas, startY: 25 });
      docPDF.save("LunaTrack_Export.pdf");
    };

    // Chat interno
    function initChat() {
      const chatFab = document.getElementById("chatFab");
      const chatDock = document.getElementById("chatDock");
      const chatMsgs = document.getElementById("chatMessages");
      const chatText = document.getElementById("chatText");
      const cerrarChatBtn = document.getElementById("cerrarChatBtn");
      const chatSendBtn = document.getElementById("chatSend");
      let chatOpen = false;
      let notifSound = null;

      document.addEventListener("click", () => { if (!notifSound) notifSound = new Audio("https://assets.mixkit.co/sfx/preview/mixkit-notification-bell-590.mp3"); });

      window.toggleChat = function() {
        chatOpen = !chatOpen;
        chatDock.classList.toggle("open", chatOpen);
        if (chatOpen) setTimeout(() => chatMsgs.scrollTop = chatMsgs.scrollHeight, 200);
      };

      chatFab.onclick = toggleChat;
      cerrarChatBtn.onclick = toggleChat;

      chatSendBtn.onclick = async () => {
        const text = chatText.value.trim();
        if (!text) return;
        await addDoc(collection(db, "chatInterno"), { user: localStorage.getItem("usuarioActual"), text, createdAt: Date.now() });
        chatText.value = "";
      };

      onSnapshot(query(collection(db, "chatInterno"), orderBy("createdAt", "asc")), snap => {
        chatMsgs.innerHTML = "";
        let last = null;
        snap.forEach(docSnap => {
          const m = docSnap.data();
          const mine = m.user === localStorage.getItem("usuarioActual");
          const div = document.createElement("div");
          div.className = `msg ${mine ? "mine" : "theirs"}`;
          div.innerHTML = `<div>${m.text}</div><div class="meta">${m.user} ‚Ä¢ ${new Date(m.createdAt).toLocaleTimeString()}</div>`;
          chatMsgs.appendChild(div);
          last = m;
        });
        chatMsgs.scrollTop = chatMsgs.scrollHeight;
        if (last && last.user !== localStorage.getItem("usuarioActual") && !chatOpen) {
          try { notifSound.currentTime = 0; notifSound.play(); } catch (e) {}
        }
      });
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
</body>
</html>
