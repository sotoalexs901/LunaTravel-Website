<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Registro - Luna Travel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css" />
  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root{
      --primary:#213D7A; --primary-dark:#1a3163; --accent:#143c8c;
      --bg:#f7f9fc; --muted:#6b7280; --green:#1b5e20; --green-bg:#e6f9e6; --danger:#e74c3c;
      --card:#fff; --border:#e5e7eb; --shadow:0 4px 10px rgba(0,0,0,0.1);
    }
    *{box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:var(--bg);margin:0;color:#111;text-align:center}
    .container{max-width:980px;margin:32px auto;background:var(--card);padding:28px;border-radius:12px;box-shadow:var(--shadow);text-align:left}
    h2{margin:0 0 16px;color:var(--primary)}
    input,select,button{font-family:inherit}
    input,select{padding:10px;border:1px solid var(--border);border-radius:8px;width:100%}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    .btn:hover{background:var(--primary-dark)}
    .btn-danger{background:var(--danger)}
    .btn-muted{background:#6b7280}
    .toolbar{display:flex;gap:12px;flex-wrap:wrap;justify-content:space-between;align-items:center;margin:16px 0}
    #tablaEnvios{width:100%;border-collapse:collapse;margin-top:12px}
    #tablaEnvios th,#tablaEnvios td{border:1px solid var(--border);padding:8px;text-align:left}
    #tablaEnvios th{background:var(--primary);color:#fff}
    .logout-btn{float:right;background:#555}
    .logout-btn:hover{background:#333}
    #contador{margin:8px 0 0;font-weight:700;color:var(--primary)}
    #mensajeConfirmacion{display:none;margin:15px auto;width:100%;padding:12px;background:var(--green-bg);color:var(--green);font-weight:600;border:1px solid #66bb6a;border-radius:8px;animation:fadeInOut 4s forwards;text-align:center}
    @keyframes fadeInOut{0%{opacity:0}10%{opacity:1}90%{opacity:1}100%{opacity:0}}
    /* Modal edici√≥n (solo Alexs) */
    .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(4px);z-index:9990}
    .modal{position:fixed;right:50%;top:50%;transform:translate(50%,-50%);background:#fff;border-radius:12px;box-shadow:var(--shadow);width:min(640px,95vw);padding:16px;z-index:9991}
    .modal h3{margin:0 0 10px;color:var(--primary)}
    .modal .grid{grid-template-columns:1fr 1fr}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    /* Chat Dock */
    .chat-fab{position:fixed;right:20px;bottom:20px;background:var(--primary);color:#fff;border:none;border-radius:50%;width:56px;height:56px;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);cursor:pointer;z-index:9800;font-size:20px}
    .chat-fab .badge{position:absolute;top:6px;right:6px;background:#3b82f6;border-radius:50%;width:10px;height:10px;display:none}
    .chat-dock{position:fixed;top:0;right:-380px;width:360px;height:100vh;background:#fff;box-shadow:-4px 0 16px rgba(0,0,0,.15);z-index:9900;display:flex;flex-direction:column;transition:right .25s ease}
    .chat-dock.open{right:0}
    .chat-header{background:var(--primary);color:#fff;padding:12px 14px;display:flex;justify-content:space-between;align-items:center}
    .chat-messages{flex:1;overflow:auto;padding:12px;background:#f8fafc}
    .msg{max-width:80%;margin:6px 0;padding:8px 10px;border-radius:10px}
    .msg.mine{margin-left:auto;background:rgba(20,60,140,.1);border:1px solid #c7d2fe}
    .msg.theirs{margin-right:auto;background:#e5e7eb}
    .msg .meta{font-size:11px;color:#555;margin-top:2px}
    .chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid var(--border)}
    .chat-input input{flex:1}
    /* Admin Badge */
    .admin-badge{display:none;margin-left:8px;padding:3px 8px;border-radius:999px;background:#10b981;color:#fff;font-size:12px;font-weight:700}
    @media (max-width:720px){.grid{grid-template-columns:1fr}.toolbar{flex-direction:column;align-items:stretch}}
  </style>
</head>

<body>
  <!-- LOGIN -->
  <div id="login" class="container" style="text-align:center;">
    <h2>Acceso Administrador</h2>
    <div class="grid" style="max-width:520px;margin:0 auto;">
      <input type="text" id="usuario" placeholder="Usuario (Alexs / Mela / Amisaday / Juan / Ana)">
      <input type="password" id="pin" placeholder="PIN">
    </div>
    <button class="btn" onclick="login()">Ingresar</button>
    <p id="loginError" style="color:#d32f2f;display:none;margin-top:8px;">Usuario o PIN incorrectos.</p>
  </div>

  <!-- PANEL -->
  <div id="panel" class="container" style="display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <h2 style="display:flex;align-items:center;gap:8px;">Panel de Registro - Luna Travel <span id="adminBadge" class="admin-badge">üîë Modo Administrador Activo</span></h2>
      <button class="btn logout-btn" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>

    <!-- Registro -->
    <div class="grid" style="margin-top:12px;">
      <input type="text" id="cliente" placeholder="Cliente">
      <input type="text" id="destinatario" placeholder="Destinatario (quien recoge)">
      <input type="text" id="destino" placeholder="Destino">
      <select id="estado">
        <option value="">Seleccionar estado...</option>
        <option>Recibido en la Oficina</option>
        <option>En Tr√°nsito</option>
        <option>Procesando para Entrega</option>
        <option>En Reparto</option>
        <option>Entregado</option>
      </select>
      <input type="text" id="ubicacion" placeholder="Ubicaci√≥n">
    </div>
    <button class="btn" onclick="guardarEnvio()">Guardar y generar recibo</button>

    <div id="recibo"></div>

    <!-- Filtros / Export -->
    <div class="toolbar">
      <div>
        <label for="filterEstado" style="font-weight:700;color:var(--primary);">Filtrar por estado:</label>
        <select id="filterEstado" onchange="filtrarEnvios()" style="padding:8px;border-radius:8px;">
          <option value="todos">Todos</option>
          <option value="recibido en la oficina">Recibido en la Oficina</option>
          <option value="en tr√°nsito">En Tr√°nsito</option>
          <option value="procesando para entrega">Procesando para Entrega</option>
          <option value="en reparto">En Reparto</option>
          <option value="entregado">Entregado</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn" onclick="exportarExcel()">üì§ Exportar Excel</button>
        <button class="btn" style="background:#c62828" onclick="exportarPDF()">üßæ Exportar PDF</button>
        <button class="btn btn-muted" onclick="imprimirFiltrado()">üñ®Ô∏è Imprimir lista filtrada</button>
      </div>
    </div>

    <!-- Esc√°ner -->
    <h3 style="margin:8px 0 6px;color:var(--primary)">Actualizar estado con esc√°ner</h3>
    <input type="text" id="scanInput" placeholder="Escanee un c√≥digo LT..." autofocus>
    <div id="actualizarForm" style="display:none;margin-top:10px;">
      <div class="grid">
        <select id="nuevoEstado">
          <option value="">Seleccionar nuevo estado...</option>
          <option>Recibido en la Oficina</option>
          <option>En Tr√°nsito</option>
          <option>Procesando para Entrega</option>
          <option>En Reparto</option>
          <option>Entregado</option>
        </select>
        <input type="text" id="nuevaUbicacion" placeholder="Nueva ubicaci√≥n (opcional)">
      </div>
      <button class="btn" onclick="confirmarActualizacion()">Actualizar</button>
    </div>

    <!-- Mensaje -->
    <div id="mensajeConfirmacion">‚úÖ Env√≠o actualizado correctamente.</div>

    <!-- Tabla -->
    <h3 style="margin:18px 0 6px;">Env√≠os registrados</h3>
    <p id="contador">üì¶ 0 env√≠os cargados</p>
    <table id="tablaEnvios">
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Cliente</th>
          <th>Destinatario</th>
          <th>Destino</th>
          <th>Estado</th>
          <th>Ubicaci√≥n</th>
          <th>Fecha</th>
          <th>Actualizado por</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaBody"></tbody>
    </table>
  </div>

  <!-- Modal edici√≥n (solo Alexs) -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h3>Editar env√≠o</h3>
      <div class="grid">
        <input type="text" id="editCodigo" placeholder="C√≥digo (LT-XXXXXX)">
        <input type="text" id="editCliente" placeholder="Cliente">
        <input type="text" id="editDestinatario" placeholder="Destinatario">
        <input type="text" id="editDestino" placeholder="Destino">
        <select id="editEstado">
          <option>Recibido en la Oficina</option>
          <option>En Tr√°nsito</option>
          <option>Procesando para Entrega</option>
          <option>En Reparto</option>
          <option>Entregado</option>
        </select>
        <input type="text" id="editUbicacion" placeholder="Ubicaci√≥n">
        <input type="text" id="editFecha" placeholder="Fecha (auto si dejas vac√≠o)">
      </div>
      <div class="modal-actions">
        <button class="btn btn-muted" onclick="cerrarModal()">Cancelar</button>
        <button class="btn" onclick="guardarEdicion()">Guardar cambios</button>
      </div>
    </div>
  </div>

  <!-- Chat Dock -->
  <button class="chat-fab" id="chatFab">üí¨<span class="badge" id="chatBadge"></span></button>
  <div class="chat-dock" id="chatDock">
    <div class="chat-header">
      <strong>üí¨ Chat del Equipo</strong>
      <button class="btn btn-muted" onclick="toggleChat()">‚ùå</button>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="chatText" placeholder="Escribe un mensaje...">
      <button class="btn" onclick="enviarMensaje()">Enviar</button>
    </div>
  </div>

  <!-- FIREBASE + L√≥gica -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, setDoc, updateDoc, deleteDoc, getDoc,
      collection, addDoc, getDocs, onSnapshot, query, orderBy, where
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUiJ9u2GyPBovgoaS64r89E1tydCP5Na4",
      authDomain: "lunatrack-95199.firebaseapp.com",
      projectId: "lunatrack-95199",
      storageBucket: "lunatrack-95199.firebasestorage.app",
      messagingSenderId: "82970120947",
      appId: "1:82970120947:web:2d7b70d052816802c05d86",
      measurementId: "G-QCYKV5DXKD"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Estado global
    let registrosEnvios = [];
    let registrosFiltrados = [];
    let codigoActual = "";
    let currentUser = "";
    let isAdmin = false;
    let editingDocId = "";  // docId actual (igual al c√≥digo)

    // ------ Login & permisos ------
    window.login = function(){
  // ------ Login y permisos ------
window.login = function() {
  const u = document.getElementById("usuario").value.trim();
  const p = document.getElementById("pin").value.trim();
  const valid = {
    "Alexs": "2036",
    "Mela": "2006",
    "Amisaday": "1994",
    "Juan": "5304",
    "Ana": "0503"
  };

  if (valid[u] && valid[u] === p) {
    // üîπ Guarda usuario actual en localStorage para el chat interno
    localStorage.setItem("usuarioActual", u);
    localStorage.setItem("rolUsuario", u === "Alexs" ? "admin" : "operador");

    currentUser = u;
    isAdmin = (u === "Alexs");

    document.getElementById("login").style.display = "none";
    document.getElementById("panel").style.display = "block";
    document.getElementById("adminBadge").style.display = isAdmin ? "inline-flex" : "none";

    cargarEnvios();
    Inicializa el chat con el nombre correcto

  } else {
    document.getElementById("loginError").style.display = "block";
  }
};

window.cerrarSesion = function() {
  // üîπ Limpia sesi√≥n y chat
  localStorage.removeItem("usuarioActual");
  localStorage.removeItem("rolUsuario");
  currentUser = "";
  isAdmin = false;

  document.getElementById("panel").style.display = "none";
  document.getElementById("login").style.display = "block";
};

      currentUser=""; isAdmin=false;
      document.getElementById("panel").style.display="none";
      document.getElementById("login").style.display="block";
    };

    // ------ Utilidades ------
    function generarCodigo(){ return `LT-${Math.floor(100000 + Math.random()*900000)}` }
    function nowStr(){ return new Date().toLocaleString() }

    // ------ Guardar Env√≠o + Recibo con c√≥digo de barras ------
    window.guardarEnvio = async function(){
      const cliente = document.getElementById("cliente").value.trim();
      const destinatario = document.getElementById("destinatario").value.trim();
      const destino = document.getElementById("destino").value.trim();
      const estado = document.getElementById("estado").value.trim();
      const ubicacion = document.getElementById("ubicacion").value.trim();
      if(!cliente || !destinatario || !destino || !estado || !ubicacion){
        alert("Completa todos los campos."); return;
      }
      const codigo = generarCodigo();
      const payload = { codigo, cliente, destinatario, destino, estado, ubicacion, fecha: nowStr(), actualizadoPor: currentUser || "Sistema", registradoPor: currentUser || "Sistema" };
      await setDoc(doc(db,"equipaje",codigo), payload);

      // Recibo con c√≥digo de barras
      const reciboDiv = document.getElementById("recibo");
      reciboDiv.innerHTML = `
        <div class="container" style="margin-top:16px;border:1px solid var(--border)">
          <h3 style="color:var(--primary);margin-top:0">Recibo de Env√≠o</h3>
          <p><strong>C√≥digo:</strong> ${codigo}</p>
          <p><strong>Cliente:</strong> ${cliente}</p>
          <p><strong>Destinatario:</strong> ${destinatario}</p>
          <p><strong>Destino:</strong> ${destino}</p>
          <p><strong>Estado:</strong> ${estado}</p>
          <p><strong>Ubicaci√≥n:</strong> ${ubicacion}</p>
          <svg id="codigoBarras"></svg>
          <button class="btn" style="margin-top:10px" onclick="window.print()">üñ®Ô∏è Imprimir Recibo</button>
        </div>`;
      JsBarcode("#codigoBarras", codigo, {format:"CODE128", width:2, height:60, displayValue:true, fontSize:16});

      // Limpia formulario y recarga
      ["cliente","destinatario","destino","estado","ubicacion"].forEach(id=>document.getElementById(id).value="");
      await cargarEnvios();
      alert("‚úÖ Env√≠o registrado correctamente.");
    };

    // ------ Cargar / Mostrar env√≠os ------
    async function cargarEnvios(){
      const q = query(collection(db,"equipaje"), orderBy("fecha","desc"));
      const qs = await getDocs(q);
      registrosEnvios = [];
      qs.forEach(docSnap => registrosEnvios.push(docSnap.data()));
      mostrarEnvios(registrosEnvios);
      document.getElementById("contador").textContent = `üì¶ ${registrosEnvios.length} env√≠os cargados`;
    }
    function renderFila(data){
      const editBtn = `<button class="btn" onclick="abrirEdicion('${data.codigo}')" title="Editar">‚úèÔ∏è</button>`;
      const delBtn  = `<button class="btn btn-danger" onclick="eliminarRegistro('${data.codigo}')" title="Eliminar">üóëÔ∏è</button>`;
      // Edit: solo Alexs, Delete: todos
      const acciones = (isAdmin ? editBtn : `<button class="btn" onclick="alert('‚ö†Ô∏è No tienes permiso para realizar esta acci√≥n.')" title="Editar">‚úèÔ∏è</button>`) + " " + delBtn;

      return `
        <tr>
          <td>${data.codigo}</td>
          <td>${data.cliente || "‚Äî"}</td>
          <td>${data.destinatario || "‚Äî"}</td>
          <td>${data.destino || "‚Äî"}</td>
          <td>${data.estado || "‚Äî"}</td>
          <td>${data.ubicacion || "‚Äî"}</td>
          <td>${data.fecha || "‚Äî"}</td>
          <td>${data.actualizadoPor || data.registradoPor || "‚Äî"}</td>
          <td>${acciones}</td>
        </tr>`;
    }
    function mostrarEnvios(lista){
      const body = document.getElementById("tablaBody");
      body.innerHTML = "";
      lista.forEach(d => body.insertAdjacentHTML("beforeend", renderFila(d)));
      registrosFiltrados = [...lista];
      document.getElementById("contador").textContent = `üì¶ ${lista.length} env√≠os cargados`;
    }

    // ------ Filtro ------
    window.filtrarEnvios = function(){
      const e = document.getElementById("filterEstado").value.toLowerCase();
      const lista = (e==="todos") ? registrosEnvios : registrosEnvios.filter(x => (x.estado||"").toLowerCase()===e);
      mostrarEnvios(lista);
    };

    // ------ Exportar ------
    window.exportarExcel = function(){
      if(registrosFiltrados.length===0) return alert("No hay registros para exportar.");
      const hoja = XLSX.utils.json_to_sheet(registrosFiltrados);
      const libro = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(libro, hoja, "Env√≠os");
      const fecha = new Date().toISOString().split("T")[0];
      XLSX.writeFile(libro, `LunaTrack_filtrado_${fecha}.xlsx`);
    };
    window.exportarPDF = function(){
      if(registrosFiltrados.length===0) return alert("No hay registros para exportar.");
      const { jsPDF } = window.jspdf;
      const docPDF = new jsPDF();
      docPDF.text("LunaTrack - Env√≠os (filtrados)", 14, 15);
      const filas = registrosFiltrados.map(d => [d.codigo,d.cliente,d.destinatario,d.destino,d.estado,d.ubicacion,d.fecha,d.actualizadoPor||d.registradoPor||""]);
      docPDF.autoTable({ head:[["C√≥digo","Cliente","Destinatario","Destino","Estado","Ubicaci√≥n","Fecha","Actualizado por"]], body:filas, startY:25 });
      const fecha = new Date().toISOString().split("T")[0];
      docPDF.save(`LunaTrack_filtrado_${fecha}.pdf`);
    };
    window.imprimirFiltrado = function(){
      if(registrosFiltrados.length===0) return alert("No hay registros para imprimir.");
      let w = window.open("", "PRINT", "height=650,width=900,top=100,left=150");
      w.document.write(`<html><head><title>Lista filtrada</title><style>
        body{font-family:'Inter',sans-serif;padding:16px}
        table{width:100%;border-collapse:collapse}
        th,td{border:1px solid #ddd;padding:6px;text-align:left}
        th{background:#213D7A;color:#fff}
      </style></head><body>`);
      w.document.write("<h3>Lista filtrada de env√≠os</h3><table><thead><tr><th>C√≥digo</th><th>Cliente</th><th>Destinatario</th><th>Destino</th><th>Estado</th><th>Ubicaci√≥n</th><th>Fecha</th><th>Actualizado por</th></tr></thead><tbody>");
      registrosFiltrados.forEach(d=>{
        w.document.write(`<tr><td>${d.codigo}</td><td>${d.cliente||""}</td><td>${d.destinatario||""}</td><td>${d.destino||""}</td><td>${d.estado||""}</td><td>${d.ubicacion||""}</td><td>${d.fecha||""}</td><td>${d.actualizadoPor||d.registradoPor||""}</td></tr>`);
      });
      w.document.write("</tbody></table></body></html>");
      w.document.close(); w.focus(); w.print(); w.close();
    };

    // ------ Esc√°ner actualizaci√≥n ------
    const scanInput = document.getElementById("scanInput");
    scanInput.addEventListener("change", ()=>{
      codigoActual = scanInput.value.trim();
      if(!codigoActual) return;
      document.getElementById("actualizarForm").style.display = "block";
      scanInput.value="";
    });
    window.confirmarActualizacion = async function(){
      const nuevoEstado = document.getElementById("nuevoEstado").value;
      const nuevaUbicacion = document.getElementById("nuevaUbicacion").value;
      if(!codigoActual) return alert("Escanee un c√≥digo primero.");
      if(!nuevoEstado) return alert("Selecciona un estado.");
      const ref = doc(db,"equipaje",codigoActual);
      const exists = await getDoc(ref);
      if(!exists.exists()) return alert("C√≥digo no encontrado.");
      await updateDoc(ref, {estado:nuevoEstado, ubicacion:(nuevaUbicacion||"Sin cambios"), fecha:nowStr(), actualizadoPor:currentUser||"Sistema"});
      document.getElementById("actualizarForm").style.display="none";
      mostrarMensaje();
      cargarEnvios();
    };
    function mostrarMensaje(){
      const msg = document.getElementById("mensajeConfirmacion");
      msg.style.display="block"; setTimeout(()=>msg.style.display="none", 3200);
    }

    // ------ Eliminar registro (todos pueden) ------
    window.eliminarRegistro = async function(codigo){
      if(!confirm(`¬øEliminar el env√≠o ${codigo}?`)) return;
      await deleteDoc(doc(db,"equipaje",codigo));
      await cargarEnvios();
    };

    // ------ Modal de edici√≥n (solo Alexs) ------
    window.abrirEdicion = async function(codigo){
      if(!isAdmin){ alert("‚ö†Ô∏è No tienes permiso para realizar esta acci√≥n."); return; }
      const ref = doc(db,"equipaje",codigo);
      const snap = await getDoc(ref);
      if(!snap.exists()) return alert("Registro no encontrado.");
      const d = snap.data();
      editingDocId = codigo;
      document.getElementById("editCodigo").value = d.codigo||"";
      document.getElementById("editCliente").value = d.cliente||"";
      document.getElementById("editDestinatario").value = d.destinatario||"";
      document.getElementById("editDestino").value = d.destino||"";
      document.getElementById("editEstado").value = d.estado||"Recibido en la Oficina";
      document.getElementById("editUbicacion").value = d.ubicacion||"";
      document.getElementById("editFecha").value = "";
      document.getElementById("modalBackdrop").style.display="block";
    };
    window.cerrarModal = function(){
      document.getElementById("modalBackdrop").style.display="none";
    };
    window.guardarEdicion = async function(){
      if(!isAdmin){ alert("‚ö†Ô∏è No tienes permiso para realizar esta acci√≥n."); return; }
      const newCode = document.getElementById("editCodigo").value.trim();
      const obj = {
        codigo:newCode,
        cliente:document.getElementById("editCliente").value.trim(),
        destinatario:document.getElementById("editDestinatario").value.trim(),
        destino:document.getElementById("editDestino").value.trim(),
        estado:document.getElementById("editEstado").value,
        ubicacion:document.getElementById("editUbicacion").value.trim(),
        fecha: (document.getElementById("editFecha").value.trim() || nowStr()),
        actualizadoPor: currentUser || "Alexs"
      };
      // si cambi√≥ el c√≥digo (doc id), crear nuevo doc y borrar el anterior
      if(newCode !== editingDocId){
        await setDoc(doc(db,"equipaje",newCode), obj);
        await deleteDoc(doc(db,"equipaje",editingDocId));
      }else{
        await updateDoc(doc(db,"equipaje",editingDocId), obj);
      }
      cerrarModal();
      await cargarEnvios();
    };

    // ------ Chat del Equipo ------
    let chatUnseen = 0;
    let chatOpen = false;
    let lastSeenTs = Date.now();

    const chatFab   = document.getElementById("chatFab");
    const chatDock  = document.getElementById("chatDock");
    const chatBadge = document.getElementById("chatBadge");
    const chatMsgs  = document.getElementById("chatMessages");
    const chatText  = document.getElementById("chatText");

    chatFab.addEventListener("click", toggleChat);
    window.toggleChat = function(){
      chatOpen = !chatOpen;
      chatDock.classList.toggle("open", chatOpen);
      if(chatOpen){ chatUnseen = 0; chatBadge.style.display="none"; lastSeenTs = Date.now(); scrollChatBottom(); }
    };
    function scrollChatBottom(){ chatMsgs.scrollTop = chatMsgs.scrollHeight; }

    async function initChat(){
      // Limpieza mensajes >24h
      const cutoff = Date.now() - (24*60*60*1000);
      const qOld = query(collection(db,"chatInterno"), where("createdAt","<", cutoff));
      const snapOld = await getDocs(qOld);
      for(const d of snapOld.docs){ await deleteDoc(d.ref); }

      // Suscripci√≥n en tiempo real
      const qChat = query(collection(db,"chatInterno"), orderBy("createdAt","asc"));
      onSnapshot(qChat, (snap)=>{
        chatMsgs.innerHTML = "";
        snap.forEach(docSnap=>{
          const m = docSnap.data();
          const mine = (m.user===currentUser);
          const div = document.createElement("div");
          div.className = `msg ${mine? 'mine':'theirs'}`;
          div.innerHTML = `<div>${m.text||""}</div><div class="meta">${m.user||"?"} ‚Ä¢ ${new Date(m.createdAt||Date.now()).toLocaleTimeString()}</div>`;
          chatMsgs.appendChild(div);
          // indicador si est√° cerrado y llegan nuevos
          if(!chatOpen && (m.createdAt || 0) > lastSeenTs){ chatUnseen++; chatBadge.style.display="block"; }
        });
        if(chatOpen) scrollChatBottom();
      });
    }
    window.enviarMensaje = async function(){
      const t = chatText.value.trim();
      if(!t) return;
      await addDoc(collection(db,"chatInterno"), { user: currentUser||"Usuario", text:t, createdAt: Date.now() });
      chatText.value=""; scrollChatBottom();
    };
  </script>
<!-- üîπ CHAT INTERNO DEL EQUIPO - LUNA TRAVEL (versi√≥n completa con notificaci√≥n visual + sonido) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    getFirestore, addDoc, collection, query, orderBy, onSnapshot, deleteDoc, getDocs, where 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // --- CONFIGURACI√ìN FIREBASE ---
  const firebaseConfig = {
    apiKey: "AIzaSyBUiJ9u2GyPBovgoaS64r89E1tydCP5Na4",
    authDomain: "lunatrack-95199.firebaseapp.com",
    projectId: "lunatrack-95199",
    storageBucket: "lunatrack-95199.firebasestorage.app",
    messagingSenderId: "82970120947",
    appId: "1:82970120947:web:2d7b70d052816802c05d86",
    measurementId: "G-QCYKV5DXKD"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- VARIABLES ---
  const currentUser = localStorage.getItem("usuarioActual") || "Invitado";
  const chatRef = collection(db, "chatInterno");
  let chatVisible = false;

  // --- AUDIO DE NOTIFICACI√ìN ---
  const notifSound = new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_9c5f0b7edc.mp3?filename=notification-3-156508.mp3");

  // --- BOT√ìN FLOTANTE ---
  const chatBtn = document.createElement("button");
  chatBtn.innerHTML = "üí¨ Chat del Equipo";
  chatBtn.style.cssText = `
    position: fixed; bottom: 20px; right: 20px; 
    background: #143c8c; color: white; font-family: Inter, sans-serif;
    border: none; border-radius: 40px; padding: 12px 18px; 
    font-weight: 500; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    z-index: 9999; transition: 0.3s;
  `;
  document.body.appendChild(chatBtn);

  // --- CAJA DE CHAT ---
  const chatBox = document.createElement("div");
  chatBox.style.cssText = `
    position: fixed; bottom: 80px; right: 20px; width: 320px; height: 400px;
    background: rgba(255,255,255,0.97); backdrop-filter: blur(6px);
    border-radius: 14px; box-shadow: 0 6px 15px rgba(0,0,0,0.25);
    font-family: Inter, sans-serif; display: none; flex-direction: column;
    overflow: hidden; z-index: 9998;
  `;
  chatBox.innerHTML = `
    <div style="background:#143c8c; color:white; padding:10px; font-weight:600; text-align:center;">
      Chat del Equipo Luna Travel üöÄ
      <div id="onlineStatus" style="font-size:11px; color:#d3e3ff; margin-top:2px;"></div>
    </div>
    <div id="chatMsgs" style="flex:1; padding:10px; overflow-y:auto; font-size:13px;"></div>
    <div style="padding:8px; background:#f1f3f6;">
      <input id="chatInput" type="text" placeholder="Escribe un mensaje..." 
        style="width:75%; padding:6px; border-radius:6px; border:1px solid #ccc; font-family:Inter;">
      <button id="chatSend" 
        style="width:20%; padding:6px; background:#143c8c; color:white; border:none; border-radius:6px; cursor:pointer;">
        Enviar
      </button>
    </div>
  `;
  document.body.appendChild(chatBox);

  // --- POP-UP DE NUEVO MENSAJE ---
  const popup = document.createElement("div");
  popup.style.cssText = `
    position: fixed; bottom: 90px; right: 25px; background: white;
    border-radius: 10px; padding: 10px 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    font-family: Inter, sans-serif; font-size: 13px; color: #143c8c;
    display: none; z-index: 9999;
  `;
  document.body.appendChild(popup);

  function showPopup(user, text) {
    popup.innerHTML = `üí¨ <b>${user}</b>: ${text}`;
    popup.style.display = "block";
    setTimeout(() => popup.style.display = "none", 4000);
  }

  // --- FUNCIONES ---
  chatBtn.onclick = () => {
    chatVisible = !chatVisible;
    chatBox.style.display = chatVisible ? "flex" : "none";
    if (chatVisible) {
      chatBtn.style.animation = "none";
      chatBtn.style.background = "#143c8c";
    }
  };

  // Estado del usuario
  const onlineStatus = document.getElementById("onlineStatus");
  onlineStatus.textContent = `üü¢ ${currentUser} en l√≠nea`;

  // Escuchar mensajes
  const msgsDiv = chatBox.querySelector("#chatMsgs");
  const q = query(chatRef, orderBy("createdAt", "asc"));
  onSnapshot(q, (snapshot) => {
    msgsDiv.innerHTML = "";
    let lastMsg;
    snapshot.forEach((docSnap) => {
      const msg = docSnap.data();
      lastMsg = msg;
      const isMine = msg.user === currentUser;
      const div = document.createElement("div");
      div.style.margin = "6px 0";
      div.style.textAlign = isMine ? "right" : "left";
      div.innerHTML = `
        <div style="
          display:inline-block; padding:6px 10px; border-radius:8px; 
          background:${isMine ? '#143c8c' : '#e9eef7'}; 
          color:${isMine ? 'white' : '#000'};
          max-width:80%; word-wrap:break-word;
        ">
          <b style="font-size:11px;">${msg.user}</b><br>${msg.text}
        </div>
        <div style="font-size:10px; color:#888;">${new Date(msg.createdAt).toLocaleTimeString()}</div>
      `;
      msgsDiv.appendChild(div);
    });
    msgsDiv.scrollTop = msgsDiv.scrollHeight;

    // --- Notificaci√≥n ---
    if (lastMsg && lastMsg.user !== currentUser && !chatVisible) {
      notifSound.play();
      chatBtn.style.animation = "pulse 1.2s infinite";
      showPopup(lastMsg.user, lastMsg.text);
    }
  });

  // Enviar mensaje
  document.getElementById("chatSend").onclick = async () => {
    const input = document.getElementById("chatInput");
    const text = input.value.trim();
    if (!text) return;
    await addDoc(chatRef, {
      user: currentUser,
      text: text,
      createdAt: Date.now()
    });
    input.value = "";
  };

  // Borrar mensajes viejos (24h)
  async function limpiarMensajesViejos() {
    const cutoff = Date.now() - 24*60*60*1000;
    const qOld = query(chatRef, where("createdAt", "<", cutoff));
    const oldSnap = await getDocs(qOld);
    for (const d of oldSnap.docs) {
      await deleteDoc(d.ref);
    }
  }
  limpiarMensajesViejos();

  // --- EFECTOS CSS ---
  const style = document.createElement("style");
  style.textContent = `
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(20, 60, 140, 0.6); }
      70% { box-shadow: 0 0 0 10px rgba(20, 60, 140, 0); }
      100% { box-shadow: 0 0 0 0 rgba(20, 60, 140, 0); }
    }
  `;
  document.head.appendChild(style);
</script>


  <!-- C√≥digo de barras -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
</body>
</html>
